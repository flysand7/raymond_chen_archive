<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why doesn’t HeapValidate detect corruption in the managed heap?</h1>  <!-- .entry-meta -->

<p>A customer had a program that was corrupting the managed heap by p/invoking incorrectly. The problem didn’t show up until the next garbage collection pass, at which point the CLR got all freaked-out-like. “According to <a href="http://support.microsoft.com/kb/286470"> Knowledge Base article 286470</a>, the <code>GFlags</code> tool is supposed to catch heap corruption, but it doesn’t catch squat.”</p>
<p> Depending on your point of view, this is either a case of the customer <a href="http://blogs.msdn.com/b/oldnewthing/archive/2006/01/16/513311.aspx"> not understanding what things mean in context</a> or of the KB article author <a href="http://blogs.msdn.com/b/oldnewthing/archive/2011/05/12/10163578.aspx"> looking at the world through kernel-colored glasses</a>. </p>
<p> The <code>GFlags</code> tool, pageheap, full pageheap, and the <code>Heap­Validate</code> function all operate on heaps, but the sense of the word <i>heap</i> here is “heaps created by the <code>Heap­Create</code> function.” If your program <a href="http://blogs.msdn.com/b/oldnewthing/archive/2005/05/19/420038.aspx"> does a <code>Virtual­Alloc</code> and then carves out sub-allocations from it</a>, well, it’s not like <code>GFlags</code> and <code>Heap­Validate</code> are psychic and can magically reverse-engineer your code in order to understand your custom heap implementation and be able to determine whether your custom heap is corrupted. </p>
<p> Clearly no such function could be written, because that’s even harder than the Halting Problem! One property of a non-corrupted heap is that it will not send the heap manager into an infinite loop. Therefore, proving that the heap is not corrupted, given no information about the heap implementation other than the code itself, would require proving that the next heap call will return. And that’s just <i>one</i> of the things the imaginary <i>ValidateAnyHeap</i> function would have to do. (We try to limit ourselves to one impossible thing at a time.) </p>
<p> The <code>Heap­Validate</code> function only knows how to validate heaps created by the <code>Heap­Create</code> function. It does not have magic insight into custom heap implementations. The <code>GFlags</code> program modifies the behavior of heaps created by the <code>Heap­Create</code> function, because it naturally does not know what debugging features you’ve added to your custom heap implementation, so it doesn’t know what it needs to do to turn them on and off. </p>
<p> As far as the kernel folks are concerned, “heap” means “something created by the <code>Heap­Create</code> function.” Anything else is just an imposter. </p>
<p> If you are looking for corruption in a custom heap implementation, then you need to go ask the authors of that custom heap implementation if they provided any debugging facilities for that heap. </p>


</body>