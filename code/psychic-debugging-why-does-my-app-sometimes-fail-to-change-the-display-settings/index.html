<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Psychic debugging: Why does my app sometimes fail to change the display settings?</h1>  <!-- .entry-meta -->

<p>A customer was having trouble with their Windows 7 Embedded system. (You can tell how old this story is because Windows 7 Embedded was still a thing.)</p>
<p>Their app runs as part of the Startup group, and they found that if a field technician replaced the system’s screen, the resolution would sometimes reset to the default, because y’know, Plug and Play is like that sometimes. To fix this, they had their app call <code>Change­Display­Settings</code> when it starts up, to ensure that the screen resolution was what they wanted. This works great… most of the time. Sometimes, the call to <code>Change­Display­Settings</code> fails. The problem was intermittent, so debugging it was difficult.</p>
<p>While searching for possible reasons why they couldn’t change the screen resolution, they discovered the <code>JOB­OBJECT_</code><code>BASIC_</code><code>UI_</code><code>RESTRICTIONS</code> structure, and in particular the <code>JOB_</code><code>OBJECT_</code><code>UI­LIMIT_</code><code>DISPLAYSETTINGS</code> flag which prevents processes in the job from calling <code>Change­Display­Settings</code>. They also remembered that <a href="https://blogs.msdn.microsoft.com/oldnewthing/20110817-00/?p=9883"> programs in the Startup group ran inside a job object</a>, and they put two and two together and concluded that Explorer was running their app in a job object that had blocked screen resolution changes.</p>
<p>The customer had a few questions: Was their theory correct? If so, is there a way to escape the job object, or is there a policy or setting that can disable the job object outright?</p>
<p>I’m going to answer the questions in the wrong order.</p>
<p>Yes, there is a way to escape the job object, but it’s not obvious. Explorer does not enable <code>JOB_</code><code>OBJECT_</code><code>LIMIT_</code><code>BREAK­AWAY_</code><code>OKAY</code> on the job. Was this due to oversight, or was it an intentional limit, but it really doesn’t matter because either way, <a href="https://blogs.msdn.microsoft.com/oldnewthing/20160329-00/?p=93214"> you have to deal with it</a>.</p>
<p>Instead, you’ll have to use sneaky tricks to break away. I called out one of them in the original article: <a href="https://blogs.msdn.microsoft.com/oldnewthing/20110817-00/?p=9883"> Use a logon-triggered scheduled task</a>. Another one is mentioned in the documentation for job objects: <a href="https://docs.microsoft.com/en-us/windows/desktop/ProcThread/job-objects"> Child processes created with the WMI method <code>Win32.</code><code>Process.</code><code>Create</code> are not associated with the job</a>.</p>
<p>Okay, next question: Is there a setting to disable the job object? Yes there is. As I noted in the original article, you can set the <code>Delay_</code><code>Sec</code> to zero to disable running Startup apps in a box.</p>
<p>But the customer said that they’re running Windows 7, and the default value for <code>Delay_</code><code>Sec</code> is already zero on Windows 7, so the only way they could end up in a job object is if somebody changed the default setting. (Given that this is an embedded system, that’s possible, though I don’t see why anybody would want to enable it. Usually, embedded systems <i>disable</i> stuff.)</p>
<p>Is their theory correct? Not really. While it’s true that Explorer can be asked to run Startup apps in a job object, it does not apply any UI restrictions on those apps. Apps in the Startup group are not blocked by the job object from changing the display settings.</p>
<p>I have a different theory about why their app cannot change the display settings: In order to change the display settings, the app must be running on the current input desktop. My theory is that under sporadic conditions, the app either starts up too soon (before the Welcome screen has switched to the application desktop), or starts up too late (at which point the screen saver may have already started).</p>
<p>Unfortunately, we never heard back from the customer, so I will never know whether my psychic powers were effective.</p>
<p> </p>


</body>