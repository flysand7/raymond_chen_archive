<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why does SHGetSpecialFolderPath take such a long time before returning a network error?</h1>  <!-- .entry-meta -->

<p>A customer reported that their program was failing to start up because the call to <code>SHGet­Special­Folder­Path(CSIDL_PERSONAL)</code> was taking a long time and then eventually returning with <code>ERROR_BAD_NETPATH</code>. The account that was experiencing this problem had a redirected network profile, “but even if he’s redirecting, why would we get the bad net path error? Does calling <code>SHGet­Folder­Path</code> actually touch the folder/network? If so, we should probably stop calling this function on the UI thread since network problems could cause our program to hang.”
 The <code>SHGet­Folder­Path</code> function will access the network if you pass the <code>CSIDL_FLAG_CREATE</code> flag, which says “Check if the folder is there, and if not, create it.”
 The customer had been passing the flag. “We’ll remove it. As if our program is going to dictate the creation of the user profile directory.”
 The <code>CSIDL_FLAG_CREATE</code> flag has been implicated in some other unwanted behavior. For example, if you pass the <code>CSIDL_FLAG_CREATE</code> flag when asking for <code>CSIDL_MYPICTURES</code>, this will create a <i>My Pictures</i> directory if there wasn’t one before. Generally speaking, you shouldn’t be creating these directories as side-effects of other actions. Corporate administrators may suppress creation of folders like <i>Pictures</i> and <i>Videos</i>, but that doesn’t do much good if your program casually creates them as part of its startup.</p>
<p> Note that <code>SHGet­Special­Folder­Path</code> and <code>CSIDL</code> values have been superseded by <code>SHGet­Known­Folder­Path</code> and <code>KNOWN­FOLDER­ID</code>. The flag corresponding to <code>CSIDL_FLAG_CREATE</code> is <code>KF_FLAG_CREATE</code>. If you want to make things even faster, consider passing the <code>KF_FLAG_DONT_VERIFY</code> flag (formerly known as <code>CSIDL_FLAG_DONT_VERIFY</code>). </p>


</body>