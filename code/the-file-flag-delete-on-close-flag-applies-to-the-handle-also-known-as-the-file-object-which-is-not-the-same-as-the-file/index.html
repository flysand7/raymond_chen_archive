<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">The FILE_FLAG_DELETE_ON_CLOSE flag applies to the handle, also known as the file object, which is not the same as the file</h1>  <!-- .entry-meta -->

<p>A customer was having trouble with the <code>FILE_FLAG_DELETE_ON_CLOSE</code> flag. “We create a file that we want to be deleted automatically when we’re finished with it. Whenever we open the file, we ask for <code>GENERIC_READ | GENERIC_WRITE</code>, and we allow all sharing (including <code>FILE_SHARE_DELETE</code>), and we pass <code>FILE_FLAG_DELETE_ON_CLOSE</code>. We can open the file multiple times in this manner, but as soon as we close any of the handles, we can’t open any new ones.” </p>
<p>Yup, that’s right. </p>
<p>The <code>FILE_FLAG_DELETE_ON_CLOSE</code> flag means that the file will be deleted when the last handle to the file object is closed. This is not the same as closing the last handle to the <i>file</i>, however. Each call to <code>Create­File</code> creates a new file object. You can create multiple handles to the same file object by calling <code>Duplicate­Handle</code>. (We saw this when we discussed <a href="http://blogs.msdn.com/b/oldnewthing/archive/2014/07/11/10541475.aspx">the effect of handle duplication on the file pointer</a>.) </p>
<p>When the last handle to a file object is closed, the file object deletes the underlying file. Existing file objects will still refer to the file, but no new ones are allowed. When there are no more file objects, then the directory entry is removed. (Removing the directory entry is what most people think of when they talk about “deleting a file”, but it’s actually just the last step in the process.) </p>
<p>Going back to the customer’s problem: It looks like they really want the file to remain valid (including allowing further <code>Create­File</code> calls to succeed) for as long as any open handle continues to refer to the file. Fortunately, the customer needed the handle only to create a memory-mapped view. The file pointer was not important. Therefore, the customer could use <code>Duplicate­Handle</code> instead of <code>Create­File</code> to get additional handles to the file. Since all of the handles refer to the same file object, the file object will not delete the file until all of the handles are closed. </p>


</body>