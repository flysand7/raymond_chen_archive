<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">How can I determine the reason why my window is closing?</h1>  <!-- .entry-meta -->

<p>A customer wanted to know whether their MFC program can determine why their window is closing, similar to <a href="https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.closereason">how WinForms does</a>. </p>
<p>The source code for WinForms is online. You can see how they do it, and then translate that to MFC. </p>
<p>Many of the <code>Close­Reason</code> values refer to actions that occurred within WinForms itself, so those are naturally generated by WinForms. Three of the reasons are external to WinForms. </p>
<ul>
<li><code>User­Closing</code>:     This is generated     <a href="https://referencesource.microsoft.com/#System.Windows.Forms/winforms/Managed/System/WinForms/Form.cs,7406">    in response to     the <code>WM_</code><code>SYS­COMMAND</code>     when the code is <code>SC_</code><code>CLOSE</code></a>.     This happens when the user closes the window     by clicking the × in the upper right corner,     or by double-clicking the system icon,     or by selecting <i>Close</i> from the system menu. </li>
<li><code>Windows­Shut­Down</code>:     This is generated     <a href="https://referencesource.microsoft.com/#System.Windows.Forms/winforms/Managed/System/WinForms/Form.cs,7544">    in response to the <code>WM_</code><code>QUERY­END­SESSION</code>     and     <code>WM_</code><code>END­SESSION</code>     messages</a>. </li>
<li><code>Task­Manager­Closing</code>:     This is generated     <a href="https://referencesource.microsoft.com/#System.Windows.Forms/winforms/Managed/System/WinForms/Form.cs,7537">    in response to the <code>WM_</code><code>CLOSE</code> message</a>,     provided it wasn’t already set by someone else with better information. </li>
</ul>
<p>The “provided it wasn’t already set by someone else with better information” is important, because many of the window closing scenarios lead to <code>WM_</code><code>CLOSE</code>. For example, the default handling for the <code>SC_</code><code>CLOSE</code> system menu command is to send the <code>WM_</code><code>CLOSE</code> message, so you will see the <code>SC_</code><code>CLOSE</code> first, followed by the <code>WM_</code><code>CLOSE</code> message. </p>
<p>Note that <code>Task­Manager­Closing</code> is inferred by the fact a <code>WM_</code><code>CLOSE</code> message arrives without any of the known preliminaries. While it’s true that Task Manager uses the <code>WM_</code><code>CLOSE</code> message to encourage an app to exit, it’s not the only program that does it. </p>
<p>A better name might be <code>External</code> or <code>Programmatic</code>. </p>


</body>