<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">The case of the mysterious "out of bounds" error from <code>CreateUri</code> and <code>memmove</code></h1>  <!-- .entry-meta -->

<p>A customer was trying to understand why their program was crashing with an <code>E_BOUNDS</code> error in what appears to be a call to <code>CreateUri</code>.</p>
<pre style="font-size: 80%;">combase!RoOriginateErrorW+0x50
wincorlib!Platform::Details::ReCreateFromException+0x40
contoso!`__abi_translateCurrentException'::`1'::catch$0+0x10
contoso!memmove+0x217f4
contoso!Windows::Foundation::IUriRuntimeClassFactory::CreateUri+0x44
contoso!Contoso::DashboardView::DashboardView_obj1_Bindings::Update_ViewModel_Layout_Groups+0x50
contoso!Contoso::DashboardView::DashboardView_obj1_Bindings::Update_ViewModel_Layout+0xe4
contoso!Contoso::DashboardView::DashboardView_obj1_Bindings::PropertyChanged+0x1134
contoso!XamlBindingInfo::XamlBindingTrackingBase::PropertyChanged+0x30
</pre>
<p>From the stack, it looks like <code>memmove</code> threw a <code>E_BOUNDS</code> C++/CX exception, which doesn’t make sense. Even more mysteriously, the <code>memmove</code> was called from <code>CreateUri</code>, but their DashboardView doesn’t manipulate URIs in any obvious way. It’s just a stack trace of nonsense.</p>
<p>Let’s try to unwind the nonsense.</p>
<p>As for the mysterious <code>memmove</code>, notice that the offset is <code>0x217f4</code>. It’s unlikely that the <code>memmove</code> function is over 100KB in size. Let’s see what’s really going on there. This is just some code that has probably been shunted into a rarely-used code page far, far away from the rest of the code, and the nearest symbol to it happens to be <code>memmove</code>.</p>
<pre>    xor     ecx,ecx
    call    contoso!__abi_translateCurrentException
    int     3       ; memmove+0x217f4
</pre>
<p>Yup, this is an exception rethrow. Since exceptions are rare, profile-guided optimization puts all the exception-handling nonsense into faraway pages so that they don’t consume valuable space in the hot code pages.</p>
<p>So why is CreateUri throwing an “out of bounds” exception?</p>
<p>Well, are you sure it’s really <code>CreateUri</code>?</p>
<p>I looked a frame higher on the stack. “Why is data binding calling <code>CreateUri</code>?”</p>
<p>The data binding code is autogenerated by the XAML compiler; it’s not checked into the source tree. Instead of trying to figure out how to build their project (so I can extract the autogenerated file), maybe I can infer what’s going on from the source.</p>
<p>One basic assumption that you make about code in general is that people who write code are doing the best they can, rather than being sadists. This means that function names will generally be descriptive of what they do, variable names will generally be descriptive of what they represent, and so on. So when I see a class called <code>DashboardView_obj1_Bindings</code>, I’m going to assume that this class is for dealing with the bindings of some object in DashboardView, and since it has a method called <code>Update_<wbr/>ViewModel_<wbr/>Layout_<wbr/>Groups</code>, it probably has something to do with updating the binding of something whose names involve the words <code>ViewModel</code>, <code>Layout</code>, and <code>Groups</code>.</p>
<p>I looked at <code>DashboardView.xaml</code> and searched for the word <code>ViewModel</code> in elements that appeared to be involved with binding.</p>
<pre>&lt;ContentControl
    Grid.Row="0"
    x:Name="TogglesGroup"
    IsTabStop="False"
    Width="360"
    Content="{x:Bind ViewModel.Layout.Groups[0], Mode=OneWay}"
    ContentTemplateSelector="{StaticResource DashboardGroupTemplateSelector}"/&gt;
</pre>
<p>Now, this wasn’t the first use of <code>x:Bind</code> in the XAML markup, so that doesn’t line up with <code>obj1</code>, but the other parts do line up (the <code>Layout</code> and <code>Groups</code>), so I chalked this up to “Maybe the XAML compiler generates bindings in some order other than the order they appear in the markup.”</p>
<p>How could this binding raise an “out of bounds” exception? Well, there’s a subscript operation, so maybe the <code>Groups</code> collection is empty.</p>
<p>I looked at the <code>Update_<wbr/>ViewModel_<wbr/>Layout_<wbr/>Groups</code> method to see if that theory lined up.</p>
<pre>Update_ViewModel_Layout_Groups:
    test    rdx,rdx
    je      ...
    mov     qword ptr [rsp+8],rbx
    mov     qword ptr [rsp+18h],rbp

    push    rsi
    push    rdi
    push    r14
    sub     rsp,20h
    mov     rbp,rdx
    mov     rsi,rcx
    test    r8d,0C0000001h
    je      ...

    xor     edx,edx
    mov     rcx,rbp
    call    contoso!Windows::Foundation::IUriRuntimeClassFactory::CreateUri
</pre>
<p>The function starts with a shrink-wrapped early-out if the first parameter is zero. (This is a C++ method, so <code>rcx</code> contains <code>this</code> and <code>rdx</code> contains the first formal parameter.) I don’t know how binding works, but presumably this is just a binding thing.</p>
<p>If the parameter is nonzero, then we build a proper stack frame, test some bits in the third parameter, and if they’re set, we call, um, <code>Create­Uri</code> with <code>nullptr</code>? That makes no sense. The XAML isn’t asking for a URI, and why is this code trying to create a URI from an empty string?</p>
<p>But then you realize that you’ve been faked out by COMDAT folding. The <code>this</code> parameter for the call to <code>Create­Uri</code> is supposed to be the <code>IUri­Runtime­Class­Factory</code>, but that’s not what we’re passing; we’re passing the first formal parameter.</p>
<p>Really, this is a call to <code>IVector::GetAt</code>, and the parameter is zero, indicating that we want the object at index zero. The functions <code>IVector::GetAt</code> and <code>Create­Uri</code> were folded because they happen to be byte-for-byte identical. They are both “Call the method at index 6 in the vtable with one parameter.” For <code>IUri­Runtime­Class­Factory</code>, that method is <code>Create­Uri</code> and the parameter is a string. For <code>IVector</code> that method is <code>Get­At</code> and the parameter is an index.</p>
<p>With this explanation, the customer realized that they did have an outstanding bug that said, “If our settings file is corrupted, we end up with no groups,” and this bug is likely an alternate manifestation of that bug.</p>


</body>