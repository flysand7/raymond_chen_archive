<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why is my delay-rendered format being rendered too soon?</h1>  <!-- .entry-meta -->

<p>Here’s a customer question:</p>
<blockquote class="m"><p>I’ve put data on the clipboard as delay-rendered, but I’m getting a <code>WM_RENDERFORMAT</code> request for my <code>CF_HDROP</code> for many operations even though nobody actually looks at the files. Operations such as right-clicking a blank space on the desktop or opening the Edit menu. I don’t want to render the data until the user hits Paste because generating the data requires me to download the file from a Web server.</p></blockquote>
<p>The <code>CF_HDROP</code> format is a list of file names, and at the time the format is generated, the files must already exist. That’s because the whole purpose of <code>CF_HDROP</code> is to describe files that already exist.</p>
<p>These simple operations cause a request for <code>CF_HDROP</code> because, as a simple list of file names, it is expected to be a fast format. The data object merely has to provide a list of things that already exist; it doesn’t have to go make them. It’s interesting that the customer wants to delay generating the <code>CF_HDROP</code> format until the user selects Paste, because the shell is asking for <code>CF_HDROP</code> specifically to see whether it should enable the Paste command in the first place!</p>
<p>That you shouldn’t generate dynamic data in response to <code>CF_HDROP</code> is also clear when you think about the lifetime issues. If you’re going to generate the files on the fly, when do you know that it’s safe to delete them? If the user drops the file onto Internet Explorer or Firefox, the Web browser is going to view the file as a Web page. You get no notification when the user closes the Web browser, and therefore you don’t know when it’s safe to delete the file. The <code>CF_HDROP</code> format describes files that already exist independent of the data object.</p>
<p>What is the correct thing to do if you want to delay-render a virtual file? Use the FileGroupDescriptor clipboard format. That’s what it’s for: Delay-rendering of virtual file contents.</p>
<p>(I’m assuming an advanced audience that knows how to use a FileGroupDescriptor. There will be a remedial course in the use of the FileGroupDescriptor sometime next year.)</p>


</body>