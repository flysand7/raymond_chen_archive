<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Feel free to stop using IMultiLanguage2::DetectInputCodepage</h1>  <!-- .entry-meta -->

<p>A customer reported that they were observing some weird behavior when passing the text of an email message to <code>IMultiLanguage2::<wbr/>DetectInputCodepage</code>. They were passing the <code>MLDETECTCP_HTML</code> flag, claiming that <a href="/code/further-adventures-in-trying-to-guess-what-encoding-a-file-is-in"> I recommended passing that flag</a>, but found that using that flag caused <code>DetectInputCodepage</code> to detect the wrong code page, whereas if they passed <code>MLDETECTCP_NONE</code>, the detection worked a little better. Not perfectly, but a little better.</p>
<p>Okay, first of all, they appear to have read only the first half of the sentence where I explained when to pass the <code>MLDETECTCP_HTML</code> flag:</p>
<blockquote class="q"><p>One thing that may not be obvious is that the program passes the <code>MLDETECTCP_HTML</code> flag <span style="border: solid 1px gray;">if the file extension is <code>.htm</code> or <code>.html</code></span>.</p></blockquote>
<p>Somehow the customer though I was recommending that you always pass the <code>MLDETECTCP_HTML</code> flag. No, you pass that flag only if you are passing in HTML. That way, the detector will not consider text inside angle brackets as evidence that the contents are written in English. That text is part of the HTML tags and is not part of the message text.</p>
<p>“The customer found that the <code>MLDETECTCP_NONE</code> flag works for them. We want to know if there are any risks of using that flag instead of the <code>MLDETECTCP_HTML</code> flag.”</p>
<p>The risk is that you might be providing correct information to the <code>DetectInputCodepage</code> function and therefore allow it to perform as intended. I guess that’s a good risk.</p>
<p>But really, feel free to stop using <code>IMultiLanguage2::<wbr/>DetectInputCodepage</code>!</p>
<p>Code page detection is never going to be reliable. The function has always been a guess. An educated guess based on available information but it’s still a guess. <a href="https://en.wikipedia.org/wiki/Bush_hid_the_facts">Guesses can be wrong</a>.</p>
<p>The customer wrote back, “For the attached message, <code>DetectInputCodepage</code> returns code page 1252 when passed <code>MLDETECTCP_NONE</code>, but when we use code page 1252 to convert the message to Unicode, the results are incorrect. If we explicitly convert with code page 28592, then the results are correct. Is there a workaround for this?”</p>
<p>The workaround is to pass 28592 when the code page is 28592. You can get the code page from other metadata attached to the message, such as a <code>charset=</code> attribute in the <code>Content-Type</code>. If that metadata is missing, then you are going to be forced to guess, and the nature of guessing is the possibility that you might guess <i>wrong</i>.</p>


</body>