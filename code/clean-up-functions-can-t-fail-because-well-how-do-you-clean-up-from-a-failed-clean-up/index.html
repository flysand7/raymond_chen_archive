<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Clean-up functions can't fail because, well, how do you clean up from a failed clean-up?</h1>  <!-- .entry-meta -->

<p>Commenter Matt asks <a href="http://blogs.msdn.com/oldnewthing/pages/407234.aspx#450040"> how you’re supposed to handle failures in functions like <code>fclose</code> or <code>CloseHandle</code></a>. Obviously, you can’t. If a clean-up function fails, there’s not much you can do because, well, how do you clean up from a failed clean-up?
 These clean-up functions fall into the category of “Must not fail for reasons beyond the program’s control.” If a program tries to close a file and it gets an error back, what can it do? Practically speaking, nothing. The only way a clean-up function can fail is if the program fundamentally screws up, say by attempting to close something that was never open or otherwise passing an invalid parameter. It’s not like a program can try to close the handle again (or worse go into loop closing the handle repeatedly until it finally closes).
 Remember this when writing your own clean-up functions. Assuming the parameters are valid, a clean-up function must succeed.
 (I will now ruin my rhetorical flourish by yammering about the <code>fclose</code> function because if I don’t, people will bring it up in the comments anyway. The <code>fclose</code> function does extra work before closing, and that extra work may indeed run into problems, but the important thing is that when <code>fclose</code> returns, the stream is well and truly closed.)</p>
<p> <b>Addendum</b>: Once again I wish to emphasize that while it may be possible for functions like <code>fclose</code> to run into errors while they are closing the stream, the point is that the result of the call to <code>fclose</code> is always a closed stream. I think most of the comments are losing sight of the point of my article and rat-holding on the various ways <code>fclose</code> can run into errors. That’s not the same as <i>failing</i>. It never fails; it always succeeds, but possibly with errors. </p>


</body>