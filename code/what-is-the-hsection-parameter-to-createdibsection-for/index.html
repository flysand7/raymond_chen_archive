<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">What is the hSection parameter to CreateDIBSection for?</h1>  <!-- .entry-meta -->

<p>The <code>CreateDibSection</code> function creates a special type of bitmap known as a DIB section. <a href="http://blogs.msdn.com/oldnewthing/archive/2006/11/16/1086835.aspx"> We’ve worked</a> <a href="http://blogs.msdn.com/oldnewthing/archive/2009/07/17/9836293.aspx"> with these guys</a> before: The feature of DIB sections that is by far the most interesting is that the raw pixels in the bitmap are mapped into your process space as if they were normal memory, which you can read from and write to directly.</p>
<blockquote class="m"><p> But what is the deal with that funky <code>hSection</code> parameter? Although the <code>ppvBits</code> parameter receives “a pointer to the location of the DIB bit values,” the documentation also says that if you pass <code>NULL</code>, then “an application cannot later obtain a handle to this memory.” That second part makes no sense. Why would I want to obtain a handle to the memory if I passed <code>NULL</code>, since I told it I didn’t have any memory to begin with? Why is it so important to call out that I can’t retrieve <code>NULL</code>? The documentation appears to go out of its way to point out something that makes no sense! </p></blockquote>
<p> Let’s look at that second part in a little more context. Here is the entire description for the <code>hSection</code> parameter:</p>
<blockquote class="q"><p> If <i>hSection</i> is NULL, the system allocates memory for the DIB. In this case, the <b>CreateDIBSection</b> function ignores the <i>dwOffset</i> parameter. An application cannot later obtain a handle to this memory. The <b>dshSection</b> member of the <b>DIBSECTION</b> structure filled in by calling the <b>GetObject</b> function will be NULL.  </p></blockquote>
<p> The “this” in “this memory” is “the memory the system allocated,” not “the memory the application passed in.” Because, as you noticed, the application didn’t pass in any memory! It’s trying to tell you that when you tell the system to allocate memory for the DIB section, you don’t get to peek back in and get the handle to the memory which the system allocated.
 Let’s look at the bigger picture here. The memory for a DIB section needs to be mapped into the application’s address space, and from the description, the application has the option of passing explicit storage in the form of a file mapping handle (and offset into that file mapping handle), or it can pass <code>NULL</code> and let GDI worry about where to store it. If you were writing the GDI code to manage the memory for DIB sections, how would you do it?
 <i>How would you do it?</i> is is another one of those problem-solving questions similar to <i>What would the world be like if that were true?</i> or <i>Imagine if two programs did this?</i> For one thing, <i>How would you do it?</i> lets you rule out designs that involve clairvoyance or psychic powers. (It’s surprising how often people quietly assume that systems are built upon clairvoyance.) For another thing, it forces you to put on a different hat and view the problem from another point of view, one which may help you understand the system better.
 If you had to implement a system where memory could be managed either in the form of a file mapping handle or a mechanism of your choice, you probably would choose as your alternate mechanism… a file mapping handle. That way, there is only one code path for memory management instead of two.
 Suppose you had to install a door security system that both you and Bob could use. Bob insists that he use a traditional metal key to unlock the door, but says you can use any system you want. Would you design a combination system that could be unlocked either with a metal key or an electronic smart card? Or would you just use a traditional keyed lock with two sets of keys, giving one of Bob and keeping the other for yourself?
 When you create a DIB section and pass <code>NULL</code> for the <code>hSection</code>, GDI simply creates an internal <code>hSection</code> and uses that. The documentation is trying to say that the internal <code>hSection</code> is inaccessible to the application.</p>
<p> Note: I don’t know if this is actually what happens internally, but it’s the simplest explanation that matches the known facts. </p>


</body>