<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Waiting for all handles with MsgWaitForMultipleObjects is a bug waiting to happen</h1>  <!-- .entry-meta -->

<p>The <code>MsgWaitForMultipleObjects</code> and <code>MsgWaitForMultipleObjectsEx</code> functions allow you to specify whether you want to want for any or all of the handles (either by passing <code>bWaitAll = TRUE</code> or by passing <code>dwFlags = MWMO_WAITALL</code>, accordingly). But you never want to wait for all handles.
 Waiting for all handles means that the call does not return unless all the handles are signalled <strong>and</strong> a window message meeting your wake criteria has arrived. Since you are typically waiting for messages out of a sense of obligation (keeping the UI thread responsive) rather than one of expectation, even if all the handles you pass become signalled, your program will still stall until a window message arrives. (And if you thought you were being a good UI citizen by using <code>MsgWaitForMultipleObjectsEx</code>, you aren’t actually helping any because waiting for all objects means that the call will not return even if a message is ready, since it’s also waiting for those handles you passed.) Functions which are built on top of the <code>MsgWaitForMultipleObjectsEx</code> function such as <code>MsgWaitForMultipleObjects</code> and <code>CoWaitForMultipleHandles</code> suffer from the same problem.
 The reason for this can be gleaned from the <code>MsgWaitForMultipleObjectsEx</code> documentation; you just have to put on your thinking cap. Notice that if a message arrives when you are waiting for any handle, the return value is <code>WAIT_OBJECT_0 + cHandles</code>. Notice also that the maximum number of objects you can wait on is <code>MAXIMUM_WAIT_OBJECTS - 1</code>. Obviously, what’s happening under the covers is that the <code>MsgWaitForMultipleObjectsEx</code> function creates a handle that will be signalled when the message queue reaches one of the states you requested in the wake mask, adds that handle to the end of the array you passed in, and then passes the whole thing to the <code>WaitForMultipleObjectsEx</code> function. (Note that the getting access to that internal handle won’t be of any use to you, the application, since you don’t know how to tell the window manager what wait states should result in the event being set.)</p>
<p> (Larry Osterman reminded me that he <a href="http://blogs.msdn.com/larryosterman/archive/2004/06/02/146800.aspx"> covered the same topic a while back</a>. So now you get to see it twice.) </p>


</body>