<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why does SetFocus fail without telling me why?</h1>  <!-- .entry-meta -->

<p>One of my colleagues was debugging a program and discovered that a call to <code>Set­Focus</code> returned <code>NULL</code>, which the documentation calls out as indicating an error condition. However, a follow-up call to <code>Get­Last­Error()</code> returned 0, which means “Everything is just fine.”</p>
<p>After much debugging, they figured it out: There was a <code>WH_</code><code>CBT</code> hook that was intercepting the <code>Set­Focus</code> call and rejecting the focus change by returning <code>TRUE</code>.</p>
<p>“It would have been nice to have received a useful error code like <code>ERROR_</code><code>YOU_</code><code>JUST_</code><code>GOT_</code><code>SCREWED_</code><code>BY_</code><code>A_</code><code>HOOK</code>.”</p>
<p>You don’t get a useful error because the window manager doesn’t know that the hook is screwing with you. You called <code>Set­Focus</code>. The window hook said, “Nope, don’t change focus. It’s all good. No worries.” The window manager says, “Okay, well, then I guess it’s all taken care of.”</p>
<p>Hooks let you modify or even replace certain parts of the window manager. If you do that, then it’s on you to do so in a manner that will not confuse the rest of the system. If your hook wants to make <code>Set­Focus</code> fail, and not set an error code, we’ll that’s your decision. The system is not going to call <code>Set­Last­Error(</code><code>ERROR_</code><code>YOU_</code><code>JUST_</code><code>GOT_</code><code>SCREWED_</code><code>BY_</code><code>A_</code><code>HOOK)</code> because that might overwrite an error code set by the hook.</p>
<p>In this specific example, the point of the <code>WH_</code><code>CBT</code> hook is to assist with computer-based training: The program installs a CBT hook, which can then do things like prevent the program from changing focus so that the window containing the training materials retains focus. The underlying assumption is that a CBT hook is going to mess around only with windows that it is already in cahoots with.</p>
<p>“Oh, this is my print dialog. I’m going to prevent it from taking focus so that my instructions on how to use the printer stays on screen with focus. I’m also going to make changes to my print dialog function so it doesn’t freak out when it fails to get focus.”</p>
<p>Whatever program installed this CBT hook didn’t limit their meddling to windows they already controlled. This means that their actions sowed confusion among other windows that weren’t part of their little game.</p>
<p>I suspect no actual computer-based training was going on at all. The CBT hook was being used not for its stated purpose of computer-based training, but rather because it provided a way to alter the behavior of the window manager in very fundamental ways, and being able to make those alterations fit into the program’s world view somehow.</p>
<p>Somebody who installs a hook can alter the behavior of the system, and it’s important that they do it right, so that their changes still maintain the contracts promised by the system. One of those being that when <code>Set­Focus</code> fails, it tells you why.</p>
<p><b>Related reading</b>: <a href="/code/the-case-of-the-file-that-won-t-copy-because-of-an-invalid-handle-error-message"> The case of the file that won’t copy because of an Invalid Handle error message</a>.</p>
<p> </p>


</body>