<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">The program “G” is preventing you from shutting down</h1>  <!-- .entry-meta -->

<p>So you’re trying to sign off or shut down, but you get a message saying that some program named “G” is preventing you. What’s going on? Who is this mysterious “G” program?</p>
<p>We noted some time ago that <a href="/other/why-does-misinterpreting-utf16-le-unicode-text-as-ansi-tend-to-show-up-as-just-one-character"> treating a UTF16-LE Unicode string as if it were an 8-bit string generally results in only the first character surviving</a>, because the high-order byte of the UTF16-LE code unit is zero for most Western European characters, and the zero byte is interpreted as the end of the 8-bit string.</p>
<p>This mismatch can go undetected by the compiler if the data came in as an untyped blob (like, say, a byte stream), or if got smuggled through some other channel that erased the original type.</p>
<p>One case where you can see this is if you call the <code>Register­ClassW</code> function to register a window class. The <code>W</code> at the end of <code>Register­ClassW</code> indicates that you want the Unicode version, and one of the things you provide is a window procedure, which will therefore be treated as a Unicode window procedure.</p>
<p>Your window procedure consequently needs to cast its <code>WPARAM</code> and <code>LPARAM</code> parameters into the Unicode versions of whatever message you are receiving.</p>
<p>And if it chooses to continue with default message handling, it needs to call the Unicode version of <code>Def­Window­Proc</code>: <code>Def­Window­ProcW</code>. That tells the system that the <code>WPARAM</code> and <code>LPARAM</code> parameters that you’re passing along should be treated as Unicode parameters, not ANSI parameters.</p>
<p>If you pass your Unicode messages to <code>Def­Window­ProcA</code>, then you’ll find that a lot of strings get truncated at their first character.</p>
<p>And that brings us back to today’s topic. What is this mysterious “G” program?</p>
<p>At the time the GDI+ library was written, it needed to support Windows 98, which had very limited support for Unicode. Therefore, it was compiled as ANSI and consequently used the ANSI versions of functions like <code>Register­Class</code>, like <code>Create­Window</code>, and <code>Def­WindowProc</code> to create and manage its helper window. The lack of Unicode support in the helper window didn’t really cause a problem because the window never displayed any UI and never processed any text. The window was there to do things like listen for <code>WM_</code><code>SETTINGS­CHANGE</code> messages so it knew when to invalidate its caches.</p>
<p>A few years ago, the GDI+ team did a little cleanup, and one of the things they did was get rid of support for Windows 98 and Windows Me. Because c’mon, Windows 98 and Windows Me went out of support over a decade ago.</p>
<p>For the most part, this meant simply recompiling GDI+ as a Unicode component rather than an ANSI component.</p>
<p>Except that the notification window procedure contained an explicit call to <code>Def­Window­ProcA</code>. Most character set mismatches would be caught by the compiler due to a type mismatch. But the character set dependency in <code>Def­Window­Proc</code> is not encoded in the parameter types. It’s implicit in how you received the message. This mismatch went undetected by the compiler.</p>
<p>This mismatch also went undetected by testing because the notification window doesn’t do any text processing. The title of the window got truncated from <tt>"GDI+ Hook Window"</tt> to simply <tt>"G"</tt>, but that title isn’t used for anything, so the error was of no consequence. The window title is never shown to the user.</p>
<p>Except when it is.</p>
<p>As we saw last time, one mistake that programs make is <a href="https://devblogs.microsoft.com/oldnewthing/20191029-00/?p=103033"> taking responsibility for the GDI+ helper window but failing to pump messages</a>. When the user tries to sign out or shut down, every window is sent a <code>WM_</code><code>QUERY­END­SESSION</code> message to let it know that the user is signing out, and this is your last chance to save your work and clean up.</p>
<p>If the application is not pumping messages, then the window will be flagged as not responding to the <code>WM_</code><code>QUERY­END­SESSION</code> message and consequently is blamed for preventing you from signing out (or shutting down).</p>
<p>When a program prevents you from signing out or shutting down, Windows looks for a visible window belonging to that program and uses that to represent it in the <a href="https://docs.microsoft.com/en-us/windows-hardware/customize/enterprise/troubleshooting-custom-logon"> Blocked Shutdown Resolver</a> (BSDR) screen. But if the program has no visible windows, then the BSDR will take <i>any</i> window belonging to the program, visible or not. And sometimes the invisible window that gets chosen is the one named “G”.</p>
<p>That’s why you end up with a message that implicates some mysterious program named “G” as the one that is preventing you from shutting down.</p>
<p>Once the problem was identified, the fix was simple: Change <code>Def­Window­ProcA</code> to plain old <code>Def­Window­Proc</code>, so that it follows the character set preference of the rest of the component, namely Unicode. This restores the full name of the window: <tt>"GDI+ Hook Window"</tt>.</p>
<p>But we took the fix one step further. Since it was clear that this window was a source of problems, we put the name of the underlying process in the window title, so that when it gets blamed for preventing you from signing out or shutting down, you have a better idea of what program is responsible.</p>
<p>The title of the window is now <tt>"GDI+ Window (contoso.exe)"</tt>. The fix is available in <a href="https://blogs.windows.com/windowsexperience/2019/10/29/announcing-windows-10-insider-preview-build-19013/"> Windows 10 Insider Preview Build 19013</a>.</p>
<blockquote class="twitter-tweet">
<p dir="ltr" lang="en">Have you ever tried shutting down, and seen a message saying “G” is preventing the operation, and thought “What is G? “</p>
<p>We investigated this, and found…<a href="https://t.co/RBzWGnEt0F">https://t.co/RBzWGnEt0F</a><a href="https://twitter.com/hashtag/WindowsInsiders?src=hash&amp;ref_src=twsrc%5Etfw">#WindowsInsiders</a> <a href="https://t.co/0sDJHkgIZv">pic.twitter.com/0sDJHkgIZv</a></p>
<p>— Jen Gentleman (@JenMsft) <a href="https://twitter.com/JenMsft/status/1189327921783160832?ref_src=twsrc%5Etfw">October 29, 2019</a></p></blockquote>
<p><script async="" charset="utf-8" src="https://platform.twitter.com/widgets.js"></script></p>
<p> </p>


</body>