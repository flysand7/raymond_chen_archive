<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">It rather involved being on the other side of this airtight hatchway: Guessing window procedure magic cookies</h1>  <!-- .entry-meta -->

<p>A security vulnerability report arrived that said that if you passed a carefully-malformed value to the <code>Call­Window­Proc</code> function, then it would call an unexpected function.</p>
<p>Recall that when you call <code>Get­Window­Long­Ptr(GWLP_</code><code>WNDPROC)</code> and the window procedure’s character set is different from the character set of th <code>Get­Window­Long­Ptr</code>, then <a href="/history/what-are-these-strange-values-returned-from-gwlp-wndproc"> the window manager returns a magic cookie</a> as the pretend window procedure. This magic cookie is meaningful only to the <code>Call­Window­Proc</code> function, and it indicates that the message parameters need to be changed from one character set to another before calling the <i>real</i> window procedure.</p>
<p>The finder wrote, “I haven’t looked into it further to see any other possible security implications.”</p>
<p>What are the security implications of letting people guess the magic cookies?</p>
<p>Nothing, really. Because you’re already on the other side of the airtight hatchway.</p>
<p>Which made me kind of confused by that statement about “other possible security implications,” since I couldn’t even see the first one.</p>
<p>Remember, when looking at a potential security issue, you have to identify who the attacker is, who the victim is, and what the attacker has gained.</p>
<p>One possible attacker is “the process that passed an artificial magic cookie to the <code>Call­Window­Proc</code> function.” But all you’re doing is attacking yourself. Even if the parameter happens to match an actual magic cookie, all you did was call a function in your own process. The <code>WPARAM</code> and <code>LPARAM</code> parameters might be transformed as part of the character set conversion, but really, what you found was a way to call a function in your own process in an extremely convoluted way.</p>
<p>Another attacker might be “an external entity which tricked a process into passing a crafted magic cookie to the <code>Call­Window­Proc</code> function.” But that means that the attacker found a way to trick a process into passing <i>a value of its choosing</i> to the <code>Call­Window­Proc</code> function. If an attacker has that much power over the process, then what’s it doing wasting its time with magic cookies? It can just trick the app into passing arbitrary function pointers to the <code>Call­Window­Proc</code> function! No need to limit yourself to functions that are callable via magic cookies; you can just call any function you like. In other words, the attacker gained nothing they didn’t already have.</p>


</body>