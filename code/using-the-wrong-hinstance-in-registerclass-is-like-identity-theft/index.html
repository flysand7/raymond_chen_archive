<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Using the wrong HINSTANCE in RegisterClass is like identity theft</h1>  <!-- .entry-meta -->

<p>Last year, I left you with a teaser for <a href="/code/decoding-the-parameters-of-a-thrown-c-exception-0xe06d7363" title="Decoding the parameters of a thrown C++ exception (0xE06D7363)"> a problem that resulted in the <code>CResource­Exception</code> being thrown</a>.</p>
<p>Studying the function that threw the exception revealed that it was thrown due to a failed call to <code>Register­Class</code>. And studying the parameters that were passed to <code>Register­Class</code> revealed that <code>HINSTANCE</code> parameter did not match the DLL. Instead of being the instance handle of the DLL, it was the instance handle of the host application.</p>
<p>Okay, now let’s apply what we learned a few years ago about <a href="https://devblogs.microsoft.com/oldnewthing/20050418-59/?p=35873" title="What is the HINSTANCE passed to CreateWindow and RegisterClass used for?"> the significance of the <code>HINSTANCE</code> parameter passed to the <code>Register­Class</code> function</a>. By passing the <code>HINSTANCE</code> of the host application, the class was registered against the namespace of the host rather than the namespace of the DLL. It’s like signing up for a credit card using somebody else’s name or checking a book out of the library with somebody else’s library card.</p>
<p>In this case, the module in question was a plug-in. It tried to register a class called, say, <code>My­Class</code>, and instead of registering against itself, it registered against the host application. Fortunately, the host application didn’t have a class called <code>My­Class</code>, so the incorrect registration didn’t cause a conflict. The book got checked out to the wrong person, but as far as the library can tell, nothing has gone wrong. It merely looks like the host application checked out a book.</p>
<p>So why did the call to <code>Register­Class</code> fail? Because <i>some other plug-in made the same mistake</i>. Plug-in B also registered its class against the host application, and by an amazing coincidence, its class was also called <code>My­Class</code>. (If you look at how MFC auto-generates class names, you can see that this name collision can happen quite easily.) If both plug-ins had registered their classes properly, there would have been no problem, because each class would have been registered against their respective DLLs, and no conflict would have arisen. But instead, two wrongs make a wronger, and since both plug-ins incorrectly registered their classes against the host, the first plug-in to register succeeds, and the second one crashes.</p>
<p>(One might argue that this is another special case of <a href="https://devblogs.microsoft.com/oldnewthing/20050607-00/?p=35413"> <i>What if two programs did this?</i></a>)</p>
<p>Both plug-ins tried to sign up for a credit card in the name of the host application. The first one got the card, and the second one was informed by the credit card company, “Your application was denied because you already have a card from us.”</p>
<p>Why did these plug-ins register against the host application instead of against their own library cards? I don’t know for sure, but my guess is that it was due to ignorance.¹ When reading the documentation, they found that they needed to fill in the <code>hInstance</code> member of the <code>WNDCLASS</code> structure. Gosh, where do I get an <code>HINSTANCE</code> from? Oh wait, I found a function that returns an <code>HINSTANCE</code>: <code>Get­Module­Handle</code>. And hey look, if I pass <code>NULL</code>, a valid <code>HINSTANCE</code> comes out. I’ll just <a href='http://www.bing.com/search?q=%2b"wc.hInstance+=+GetModuleHandle(NULL)"'> set <code>wndclass.<wbr/>hInstance = Get­Module­Handle(NULL);</code></a> and try it. Hey, look, it works!</p>
<p><b>Footnote</b></p>
<p>¹ This reminds me of a story that took place at an administrative hearing. The government agency representative presented as evidence that the other party admitted in a telephone conversation to being ignorant of the applicable regulations.</p>
<p>The other party angrily interrupted.</p>
<p>“I’m not ignorant! I simply didn’t know what the rules were.”</p>
<p>The judge patiently explained, “That’s what the word <i>ignorant</i> means.”</p>


</body>