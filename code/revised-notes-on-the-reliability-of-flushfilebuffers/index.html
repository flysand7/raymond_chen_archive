<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Revised notes on the reliability of FlushFileBuffers</h1>  <!-- .entry-meta -->

<p>Some time ago, I wrote on <a href="https://devblogs.microsoft.com/oldnewthing/">the hard drives that lie about flushing file buffers (and the drivers who love them)</a>. Here’s a check-in on what’s happened over the past few years. </p>
<p>As things stand today, you can rely on <code>Flush­File­Buffers</code> committing your changes to physical disk. (Noting of course that <a href="https://devblogs.microsoft.com/oldnewthing/">this operation is expensive and may not actually help you</a> if you aren’t updating your data transactionally.) </p>
<p>Historically, NTFS used the <a href="https://msdn.microsoft.com/library/windows/desktop/dd979523(v=vs.85).aspx">Force Unit Access flag</a> to indicate to the driver that it should wait until the information is committed to non-volatile storage before signaling that the operation has completed. The conventional technique to force writes to go to media is to pass <code>FILE_FLAG_WRITE_THROUGH</code>, which internally tells the file system to set the FUA flag on I/O operations to that file. But as noted in <a href="http://perspectives.mvdirona.com/2008/04/disks-lies-and-damn-disks/">this article</a>, in the Windows 7 time frame, EIDE and SATA drivers do not respect the FUA flag, which means that your writes may still be buffered by the drive’s internal memory. </p>
<p>Fortunately, even with those drivers, the <code>Flush­File­Buffers</code> function will send the <code>FLUSH_CACHE</code> command, which tells the drive, “Hey, I know you have internal buffers. Look at me when I’m talking to you. Yes, you. With the internal buffers. Go flush them.” Fortunately, nearly all drivers in the Windows 7 era respect that command. (There are a few stragglers that still ignore it.) </p>
<p>Fast-forward to Windows 8. Support for <code>FLUSH_CACHE</code> is required by all drives in order to be declared compatible with Windows 8, and the Windows storage team has worked with hard drive vendors to ensure that <code>FLUSH_CACHE</code> is properly respected. NTFS switched from using the FUA flag to the <code>FLUSH_CACHE</code> command to enforce consistency of its metadata. </p>
<p>Note that if an application opens a file with the <code>FILE_FLAG_WRITE_THROUGH</code> flag, NTFS still sets the FUA flag on the write operations. But as noted above, EIDE and SATA drivers do not respect the FUA flag, so asking for <code>FILE_FLAG_WRITE_THROUGH</code> doesn’t give you any additional robustness in those cases. </p>
<p>If you want to flush the data to physical media, the <code>Flush­File­Buffers</code> function is your ticket. </p>
<p>As noted in the linked article, there are options in the UI to disable the signal to flush intermediate buffers, but you should use them only if you have a separate UPS for the hard drive, or if you simply don’t mind that the drive can get corrupted in the event of a power failure. </p>


</body>