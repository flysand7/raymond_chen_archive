<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Do not overload the E_NOINTERFACE error</h1>  <!-- .entry-meta -->

<p>One of the more subtle ways <a href="http://blogs.msdn.com/oldnewthing/archive/2004/03/26/96777.aspx"> people mess up <code>IUnknown::QueryInterface</code></a> is returning <code>E_NOINTERFACE</code> when the problem wasn’t actually an unsupported interface. The <code>E_NOINTERFACE</code> return value has very specific meaning. Do not use it as your generic “gosh, something went wrong” error. (Use an appropriate error such as <code>E_OUTOFMEMORY</code> or <code>E_ACCESSDENIED</code>.)
 Recall that the rules for <code>IUnknown::QueryInterface</code> are that (in the absence of catastrophic errors such as <code>E_OUTOFMEMORY</code>) if a request for a particular interface succeeds, then it must always succeed in the future for that object. Similarly, if a request fails with <code>E_NOINTERFACE</code>, then it must always fail in the future for that object.
 These rules exist for a reason.
 In the case where COM needs to create a proxy for your object (for example, to marshal the object into a different apartment), the COM infrastructure does a lot of interface caching (and negative caching) for performance reasons. For example, if a request for an interface fails, COM remembers this so that future requests for that interface are failed immediately rather than being marshalled to the original object only to have the request fail anyway. Requests for unsupported interfaces are very common in COM, and optimizing that case yields significant performance improvements.
 If you start returning <code>E_NOINTERFACE</code> for problems other than “The object doesn’t support this interface”, COM will assume that the object really doesn’t support the interface and may not ask for it again even if you do. This in turn leads to very strange bugs that defy debugging: You are at a call to <code>IUnknown::QueryInterface</code>, you set a breakpoint on your object’s implementation of <code>IUnknown::QueryInterface</code> to see what the problem is, you step over the call and get <code>E_NOINTERFACE</code> back without your breakpoint ever hitting. Why? Because at some point in the past, you said you didn’t support the interface, and COM remembered this and “saved you the trouble” of having to respond to a question you already answered. The COM folks tell me that they and their comrades in product support end up spending hours debugging customer’s problems like “When my computer is under load, sometimes I start getting <code>E_NOINTERFACE</code> for interfaces I definitely support.”</p>
<p> Save yourself and the COM folks several hours of frustration. Don’t return <code>E_NOINTERFACE</code> unless you really mean it. </p>


</body>