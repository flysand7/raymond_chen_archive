<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">A shell extension is a guest in someone else's house; don't go changing the carpet</h1>  <!-- .entry-meta -->

<p>A customer was running into this problem with a shell extension:</p>
<blockquote class="q"><p> I am writing a shell namespace extension. I need to get data from a COM server, which requires impersonation via <code>CoInitializeSecurity</code> with <code>RPC_C_IMP_LEVEL_IMPERSONATE</code>. As I am just writing an extension into <code>explorer.exe</code>, I am not able to call <code>CoInitialize</code>, <code>CoInitializeSecurity</code> anymore from my extension. Is there a way I can start <code>explorer.exe</code> by setting <code>RPC_C_IMP_LEVEL_IMPERSONATE</code> in its COM initialization? I was browsing through web, and <code>explorer.exe</code> seems to take some settings from registry, but couldn’t find anything related to this one.  </p></blockquote>
<p> First of all, who says that the host process is <code>explorer.exe</code>? If I open Notepad, then do a File.Open, and then navigate to your shell extension, boom, your shell extension is now loaded into Notepad, and I doubt you told Notepad that you wanted it to initialize COM in a special way, just for you. Same goes for Quicken, Lotus Notes, all those other programs that use the shell. Even if you solved the problem for Explorer, that doesn’t solve your problem in general.
 Second, <a href="http://blogs.msdn.com/oldnewthing/archive/2005/06/07/426294.aspx"> what if two shell extensions did this</a>? Your shell extension requires <code>RPC_C_IMP_LEVEL_IMPERSONATE</code>, but another one requires <code>RPC_C_IMP_LEVEL_DELEGATE</code>. Who wins? Or are those shell extensions mutually incompatible? And what about the effect your decision has on the other shell extensions hosted by Explorer? Now they are running with <code>RPC_C_IMP_LEVEL_IMPERSONATE</code> even though they didn’t ask for it. Will that introduce a security vulnerability? Will those other shell extensions stop working or even crash?
 A shell extension is a guest in the host process’s house. You don’t go and change the color of the carpet when you are invited over for dinner.</p>
<p> This question is yet another example of <a href="http://blogs.msdn.com/oldnewthing/archive/2008/12/11/9193695.aspx"> using a global setting to solve a local problem</a>. To solve your local problem (<i>I need this specific COM interface to run with impersonation</i>), <a href="http://msdn.microsoft.com/ms686614.aspx"> use a local solution</a>. </p>


</body>