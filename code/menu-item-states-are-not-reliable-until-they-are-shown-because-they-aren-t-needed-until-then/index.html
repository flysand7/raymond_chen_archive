<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Menu item states are not reliable until they are shown because they aren't needed until then</h1>  <!-- .entry-meta -->

<p>A question arrived from a customer (with the rather unhelpful subject line <i>Question for Microsoft</i>) wondering why, when they call <code>Get­System­Menu</code> and then ask for the states of the various menu items like <code>SC_MINIMIZE</code>, the menu item states don’t reflect reality. The menu item states don’t synchronize with reality until the user actually opens the system menu.
 There is no requirement that applications keep menu item states continuously in sync. After all, that’s why we have messages like <code>WM_INIT­MENU</code>: To tell the application, “Whoa, we’re about to show this menu, so you might want to comb its hair and pick the food out of its teeth so it can be seen by the user.” Lazy evaluation is common, because <a href="http://blogs.msdn.com/oldnewthing/archive/2007/01/22/1508494.aspx"> maintaining states continuously can be expensive</a>, and there’s no point constantly turning items on and of and on and off if the user can’t see them anyway.
 This is double-true for system menus, because maintaining the states continuously is not possible <a href="http://blogs.msdn.com/b/oldnewthing/archive/2010/05/28/10016691.aspx"> when the system menu is being shared across windows</a>. The menu states are not synchronized to the window until the menu is about to be displayed.
 If you want to know whether the <code>SC_MINIMIZE</code> menu item <i>would be</i> enabled if the menu were shown, you can check the window styles: A window can be minimized if it has a <code>WS_MINIMIZE­BOX</code> and is not already <code>WS_MINIMIZE</code>d. Similar logic can be applied to the other menu items.
 Well, except for <code>SC_CLOSE</code>. While in most cases the window caption determines what is enabled on the menu, the Close button works backward: It is the state of the menu item that controls whether the Close button is enabled. So in the special case of <code>SC_CLOSE</code>, you <i>can</i> query the state at any time, because for that case, the menu controls the state rather than simply reflecting it.
 Why is <code>SC_CLOSE</code> so special? Here come da history.
 The Close button was added in Windows 95. Since versions of Windows prior to Windows 95 didn’t have a Close button, they didn’t need a style to specify whether the Close button should be enabled or not. (You don’t need a style to control something that doesn’t exist.) Windows 95 added the Close button and hooked it up to the only thing that it had available, namely, the <code>SC_CLOSE</code> item on the system menu. Sure, Windows 95 could have have invented a new window style, but since <code>SC_CLOSE</code> already existed and applications were already using it, using <code>SC_CLOSE</code> to control the Close button allowed old applications to reap the benefits of the new Close button automatically. It also meant that there was one less thing you had to change when porting your program to Windows 95.</p>
<p> <b>Bonus chatter</b>: You can now answer <a href="http://blogs.msdn.com/b/oldnewthing/archive/2010/06/04/10019758.aspx#10020458"> Alex Cohn’s question</a>: </p>
<blockquote class="q"><p> I wonder if the EnableMenuItem method will work for minimize and maximize, too. After all, these buttons also have siblings in the Alt-space menu. </p></blockquote>


</body>