<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why does my program run really slow or even crash (or stop crashing, or crash differently) if running under a debugger?</h1>  <!-- .entry-meta -->

<p>More than once, a customer has noticed that running the exact same program under the debugger rather than standalone causes it to change behavior. And not just in the “oh, the timing of various operations changed to hit different race conditions” but in much more fundamental ways like “my program runs really slow” or “my program crashes in a totally different location” or (even more frustrating) “<a href="http://blogs.msdn.com/b/larryosterman/archive/2008/09/03/anatomy-of-a-heisenbug.aspx">my bug goes away</a>“.</p>
<p> What’s going on? I’m not even switching between the retail and debug versions of my program, so I’m not a victim of <a href="http://blogs.msdn.com/b/oldnewthing/archive/2006/08/15/701130.aspx"> changing program semantics in the debug build</a>. </p>
<p> When a program is running under the debugger, some parts of the system behave differently. One example is that the <code>Close­Handle</code> function raises an exception (I believe it’s <code>STATUS_INVALID_HANDLE</code> but don’t quote me) if you ask it to close a handle that isn’t open. But the one that catches most people is that when run under the debugger, an alternate heap is used. This alternate heap has a different memory layout, and it does extra work when allocating and freeing memory to help try to catch common heap errors, like filling newly-allocated memory with a known sentinel value. </p>
<p> But this change in behavior can make your debugging harder or impossible. </p>
<p> So much for people’s suggestions to <a href="http://blogs.msdn.com/b/oldnewthing/archive/2010/01/11/9946339.aspx"> switch to a stricter implementation of the Windows API when a debugger is attached</a>. </p>
<p> On Windows XP and higher, you can <a href="http://msdn.microsoft.com/library/ff538841.aspx"> disable the debug heap even when debugging</a>. If you are using a <code>dbgeng</code>-based debugger like <code>ntsd</code> or <code>WinDbg</code>, you can pass the <code>-hd</code> command line switch. If you are using Visual Studio, you can <a href="http://mackeblog.blogspot.com/2009/02/disabling-visual-studios-debugger-heap.html"> set the <code>_NO_DEBUG_HEAP</code> environment variable to <code>1</code></a>. </p>
<p> If you are debugging on a version of Windows prior to Windows XP, you can start the process without a debugger, then connect a debugger to the live process. The decision to use the debug heap is made at process startup, so connecting the debugger afterwards ensures that the retail heap is chosen. </p>


</body>