<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">How do the menu functions find items?</h1>  <!-- .entry-meta -->

<p>Most of the menu item functions such as <code>GetMenuItemInfo</code> allow you specify the menu item either by position or by command. Some of them use the <code>MF_BYPOSITION</code> and <code>MF_BYCOMMAND</code> flags. Others separate the search algorithm into a separate <code>fByPosition</code> flag.
 Searching for menu items by position is straightforward: The specified position is used as a zero-based index into the menu. In other words, the first item in the menu is item zero.
 Searching for menu items by command is trickier. The menu manager searches the entire menu hierarchy, <strong>including submenus</strong>, for an item with the command you specify. If more than one menu item has the identifier you requested, then one of them is chosen arbitrarily. Searching the hierarchy for a command means that you can, for example, remove or disable a menu item by just passing the root menu (which you typically have easy access to) and the item identifier. If the submenus were not searched, then synchronizing menu states would be a much more cumbersome affair.
 But what if your menu has multiple items with the same identifier? Well, the short answer is, “Then don’t use <code>MF_BYCOMMAND</code>.” You can still use <code>MF_BYPOSITION</code> to access your menu items. But why would you have multiple items with the same identifier in the first place? When the user selects the menu, a <code>WM_COMMAND</code> is posted to the window with the menu identifier as one of its parameters, and none of the other parameters gives you the menu handle. If you have multiple menu items with the same identifier, you won’t be able to tell which of them the user picked!
 There was <a href="http://groups.google.com/group/microsoft.public.win32.programmer.gdi/msg/168795212a13d297"> an emotional discussion a while back</a> that generated far more heat than light. But I can use my psychic powers to explain what that person was seeing, even though not enough information was provided in the original problem description, and it’s not a bug in Windows.
 Addressing the original complaint: If you have a menu with more than one item with the same identifier, then <code>MF_BYCOMMAND</code> is ambiguous, and all that is promised is that <strong>some</strong> item with that identifier will be found. It might not be the one you wanted, but since you gave multiple items the same name, the menu manager did the best it could. This is analogous to other searching functions like <code>FindWindow</code> and <code>GetDlgItem</code>, which operate on the first item they find. If multiple items match the criteria you specify, it just returns one of them.</p>
<p> As for the specific problem: It so happens that there is no cache, at least not yet. (But who knows, there might be a cache in the future if we discover that lots of applications query for the same item in rapid succession.) But what this person didn’t realize is that the unnamed custom GUI library they’re using doesn’t create submenus until the <code>WM_INITMENUPOPUP</code> message is received. The reason why the item isn’t found before the submenu is opened is that until the submenu is opened, <strong>the submenu doesn’t exist</strong>. And naturally, you can’t find something that doesn’t exist. </p>


</body>