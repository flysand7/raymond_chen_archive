<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why do I get spurious WM_MOUSEMOVE messages?</h1>  <!-- .entry-meta -->

<p>         In order to understand this properly, it helps to know where <code>WM_MOUSEMOVE</code> messages         come from.      </p>
<p>         When the hardware mouse reports an interrupt, indicating that the physical mouse has         moved, Windows determines which thread should receive the mouse move message and sets         a flag on that thread’s input queue that says, “The mouse moved, in case anybody cares.”         (Other stuff happens, too, which we will ignore here for now. In particular, if a         mouse button event arrives, a lot of bookkeeping happens to preserve the virtual input         state.)      </p>
<p>         When that thread calls a message retrieval function like <code>GetMessage</code>,         and the “The mouse moved” flag is set, Windows inspects the mouse position and does         the work that is commonly considered to be part of mouse movement: Determining the         window that should receive the message, changing the cursor, and determining what         type of message to generate (usually <code>WM_MOUSEMOVE</code> or perhaps <code>WM_NCMOUSEMOVE</code>).      </p>
<p>         If you understand this, then you already see the answer to the question, “Why does         my program not receive all mouse messages if the mouse is moving too fast?”      </p>
<p>         If your program is slow to call <code>GetMessage</code>, then multiple mouse interrupts         may arrive before your program calls <code>GetMessage</code> to pick them up. Since         all that happens when the mouse interrupt occurs is that a flag is set, if two interrupts         happen in succession without a message retrieval function being called, then the second         interrupt will merely set a flag that is already set, which has no effect. The net         effect is that the first interrupt acts as if it has been “lost” since nobody bothered         to pick it up.      </p>
<p>         You should also see the answer to the question, “How fast does Windows deliver mouse         movement messages?”      </p>
<p>         The answer is, “As fast as you want.” If you call <code>GetMessage</code> frequently,         then you get mouse messages frequently; if you call <code>GetMessage</code> rarely,         then you get mouse messages rarely.      </p>
<p>         Okay, so back to the original question, “Why do I get spurious WM_MOUSEMOVE messages?”      </p>
<p>         Notice that the delivery of a mouse message includes lots of work that is typically         thought of as being part of mouse movement. Often, Windows wants to do that follow-on         work even though the mouse hasn’t actually moved. The most obvious example is when         a window is shown, hidden or moved. When that happens, the mouse cursor may be over         a window different from the window it was over previously (or in the case of a move,         it may be over a different part of the same window). Windows needs to recalculate         the mouse cursor (for example, the old window may have wanted an arrow but the new         window wants a pointy finger), so it <i>artificially sets the “The mouse moved, in         case anybody cares” flag</i>. This causes all the follow-on work to happen, a side-effect         of which is the generation of a spurious <code>WM_MOUSEMOVE</code> message.      </p>
<p>     So if your program wants to detect whether the mouse has moved, you need to add a     check in your <code>WM_MOUSEMOVE</code> that the mouse position is different from     the position reported by the previous <code>WM_MOUSEMOVE</code> message.  </p>


</body>