<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why can’t I __declspec(dllexport) a function from a static library?</h1>  <!-- .entry-meta -->

<p>A customer was having trouble exporting a function with the <code>__decl­spec(<wbr/>dll­export)</code> declaration specified, but found that if the function was in a static library, no function was exported. Why is that?</p>
<p>Let’s go back to <a href="/code/understanding-the-classical-model-for-linking-groundwork-the-algorithm"> the classical model for linking</a>. Code is pulled from a LIB file only if the linker encounters a reference to it. If the linker encounters no reference to any symbols offered by an OBJ file in that LIB, then that OBJ file is not included in the final image. (Remember, we’re talking about OBJ files inside LIBs; explicitly-provided OBJ files are always included in the image, under the classical model.)</p>
<p>Now consider a LIB which contains an OBJ file that has a function marked <code>__decl­spec(<wbr/>dll­export)</code>. Suppose that no symbol offered by that OBJ file is ever required by the final image. That means that the OBJ file is never added to the image. And that means that the linker does not see the <code>__decl­spec(<wbr/>dll­export)</code> qualifier on the function inside the OBJ file (since the OBJ file was never used), so the function doesn’t get exported.</p>
<p>Let’s look at it another way: <code>__decl­spec(<wbr/>dll­export)</code> does not influence the linking process. All it does is add a little sticker to the function that says, “For export.” When the linker adds functions to an image, it makes note of the sticker and adds it to the list of functions that it needs to export. But if the linker never sees the function, then it never sees the sticker.</p>
<p>In order to export a function from a static library, you need to force a reference to the function from the image. One way is to add an OBJ to the image that contains a dummy function that calls the function you want to export. That dummy function will trigger the resolution of the symbol from the static library, at which point the linker will see the sticker.</p>
<p>Another way is to use the <code>/INCLUDE</code> directive to create an artificial reference to the function from the command line, but this gets you into the fragile world of having to know the various name decoration schemes for different architectures.</p>
<p>The best solution is to use an explicit <code>DEF</code> file, since that also gives you a chance to do other things like remove the decorations from the function (so that it can be <code>Get­Proc­Address</code>ed).</p>
<p><b>Exercise</b>: “But sometimes the <code>__decl­spec(<wbr/>dll­export)</code> works from a static library, even though I did none of those special things.” Explain.</p>


</body>