<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">If the system says that an embedded string could not be converted from Unicode to ANSI, maybe it's trying to tell you something</h1>  <!-- .entry-meta -->

<p>It’s probably trying to tell you that an embedded string could not be converted from Unicode to ANSI.</p>
<blockquote class="q"><p> One of our programs is throwing the exception “Type could not be marshaled because an embedded string could not be converted from Unicode to ANSI.” It happens only if we use the Chinese version of the program. Why are we getting this exception? </p></blockquote>
<p> I may be going out on a limb here, but I bet it’s because an embedded string could not be converted from Unicode to ANSI.
 Unicode is big. Bigger than any ANSI code page. No matter what ANSI code page you pick, there will be Unicode characters that cannot be expressed in it. (And no, you can’t set your ANSI code page to UTF-8. <a href="http://blogs.msdn.com/michkap/"> Michael Kaplan</a> discussed it <a href="http://blogs.msdn.com/michkap/archive/2006/10/11/816996.aspx"> last October</a>, and before that, <a href="http://blogs.msdn.com/michkap/archive/2006/07/14/665714.aspx"> last July</a>, and before that, <a href="http://blogs.msdn.com/michkap/archive/2006/07/04/656051.aspx#656102"> a week and a half previous (still July)</a>, and before that, <a href="http://blogs.msdn.com/michkap/archive/2005/02/06/368081.aspx#368495"> two years ago February</a>. I think Michael might need to change the subtitle of his blog to “Explaining why the ANSI code page can’t be UTF-8 since 2005”.)
 In particular, if you grab some Chinese characters and try to map them to <a href="http://www.microsoft.com/globaldev/reference/sbcs/1252.htm"> the ANSI code page on an English system</a>, they definitely won’t map successfully.
 The real question, though, is why you’re using ANSI in the first place. Get with the program, it’s 2007 already. <a href="http://blogs.msdn.com/michkap/archive/2006/10/24/867880.aspx"> As Michael Kaplan noted</a>, it’s all Unicode all the time from now on. In that same article from Michael, he also does the necessary psychic debugging for the root cause: The <code>DllImport</code> declaration did not specify a <code>CharSet</code>, so you get the default, which is <code>CharSet.Ansi</code>!</p>
<p> Change your character set to <code>CharSet.Unicode</code> and you’ll be all set. </p>


</body>