<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">During process termination, the gates are now electrified</h1>  <!-- .entry-meta -->

<p>It turns out that my <a href="http://blogs.msdn.com/oldnewthing/archive/2007/05/03/2383346.aspx"> quick overview of how processes exit on Windows XP</a> was already out of date when I wrote it. Mind you, the information is still accurate for Windows XP (as far as I know), but the rules changed in Windows Vista.</p>
<blockquote class="q"><p> What about critical sections? There is no “Uh-oh” return value for critical sections; <code>EnterCriticalSection</code> doesn’t have a return value. <strike> Instead, the kernel just says “Open season on critical sections!” I get the mental image of all the gates in a parking garage just opening up and letting anybody in and out.</strike> </p></blockquote>
<p> In Windows Vista, the gates don’t go up. Instead they become electrified!
 If during <code>DLL_PROCESS_DETACH</code> at process termination on Windows Vista you call <code>EnterCriticalSection</code> on a critical section that has been orphaned, the kernel no longer responds by just letting you through. Instead, it says, “Oh dear, things are in unrecoverably bad shape. Best to just terminate the process now.” If you try to enter an orphaned critical section during process shutdown, the kernel simply calls <code>TerminateProcess</code> on the current process!
 It’s sort of like the movie <a href="http://www.quotedb.com/quotes/175"> <i>Speed</i></a>: If the thread encounters a critical section that causes it to drop below 50 miles per hour, it blows up.
 Fortunately, this error doesn’t change the underlying analysis of <a href="http://blogs.msdn.com/oldnewthing/archive/2007/05/04/2402028.aspx"> How my lack of understanding of how processes exit on Windows XP forced a security patch to be recalled</a>.</p>
<p> But it also illustrates how the details of process shutdown are open to changes in the implementation at any time, so you shouldn’t rely on them. Remember <a href="http://blogs.msdn.com/oldnewthing/archive/2007/05/02/2365433.aspx"> the classical model for how processes exit</a>: You cleanly shut down all your worker threads, and then call <code>ExitProcess</code>. If you don’t follow that model (and given the current programming landscape, you pretty have no choice but to abandon that model, what with DLLs creating worker threads behind your back), it’s even more important that you follow the general guidance of <a href="http://blogs.msdn.com/oldnewthing/archive/2004/01/27/63401.aspx"> not doing anything scary in your <code>DllMain</code> function</a>. </p>


</body>