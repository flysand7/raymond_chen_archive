<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Foreground activation permission is like love: You can’t steal it, it has to be given to you</h1>  <!-- .entry-meta -->

<p><i>This is the blog entry that acted as the inspiration for the last topic in <a href="https://channel9.msdn.com/pdc2008/PC43/"> my 200 PDC talk</a>.</i></p>
<p> When somebody launches a second copy of your single-instance program, you usually want the second copy to send its command line to the first instance (and <a href="http://blogs.msdn.com/oldnewthing/archive/2007/06/29/3594231.aspx"> deal with the current directory somehow</a>), and then you want the first instance to come to the foreground. But a common problem people run into is that <a href="http://groups.google.com/groups?selm=eTrZ6.86681%24Uo3.2127555@news6.giganews.com"> when the first instance calls <code>SetForegroundWindow</code>, it fails</a>. </p>
<p> The problem with this design is that as far as the window manager is concerned, what happened is that the first instance received a message and then decided to steal foreground. That message wasn’t an input message, so the window manager sees no reason for the first instance to have any right to take the foreground. There is no evidence that the first instance is coming to the foreground in response to some user action. </p>
<p> There are a variety of ways of addressing this problem. The easiest way is simply to have the second instance make the call to <code>SetForegroundWindow</code>. The second program has permission to take the foreground because you just launched it. And if a program can take the foreground, it can also give it away, in this case, by setting the first program as the foreground window. </p>
<p> Another way to do this is to have the second program call the <code>AllowSetForegroundWindow</code> function with the process ID of the first program before it sends the magic message. The <code>AllowSetForegroundWindow</code> function lets a program say to the window manager, “It’s okay; he’s with me.” And then when the first program finally gets around to calling <code>SetForegroundWindow</code>, the window manager says, “Oh, this guy’s okay. That other program vouched for him.” </p>
<p> If you are transferring foreground activation to a COM server, you can use the corresponding COM function <code>CoAllowSetForegroundWindow</code>. </p>
<p> In all cases, note that <a href="http://blogs.msdn.com/oldnewthing/archive/2008/05/27/8553638.aspx"> you can’t give away something that’s not yours</a>. If you don’t have permission to take foreground, then calling <code>AllowSetForegroundWindow</code> (or one of its moral equivalents) will have no effect: You just told the window manager, “It’s okay; he’s with me,” and the window manager replied, “Who the hell are you?” </p>
<p> <b>Pre-emptive snarky comment</b>: “There are some really sneaky people who found a way to circumvent the rules and steal foreground activation.” Well yeah, and there are some really sneaky people who find ways to steal love, so there you have it. If everything is right with the world, both groups of people will eventually be found out and made to <a href="http://blogs.msdn.com/oldnewthing/archive/2008/08/01/8795860.aspx"> suffer for their malfeasance</a>. </p>
<p> Update (02/21): Deleted all comments that showed ways of circumventing the rules. Duh, people. </p>


</body>