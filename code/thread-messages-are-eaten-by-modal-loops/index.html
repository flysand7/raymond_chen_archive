<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Thread messages are eaten by modal loops</h1>  <!-- .entry-meta -->

<p>
Thread messages (as generated by
<a href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/messagesandmessagequeues/messagesandmessagequeuesreference/messagesandmessagequeuesfunctions/postthreadmessage.asp">
the <code>PostThreadMessage</code> function</a>)
do not go anywhere when passed to
<a href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/messagesandmessagequeues/messagesandmessagequeuesreference/messagesandmessagequeuesfunctions/dispatchmessage.asp">
the <code>DispatchMessage</code> function</a>.
This is obvious if you think about it, because there is no window
handle associated with a thread message.
<code>DispatchMessage</code> has no idea what to do with a message
with no associated window.
It has no choice but to throw the message away.
</p>
<p>
This has dire consequences for threads which enter modal loops,
which any thread with a window almost certainly will do at one
time or another.
Recall that the traditional modal loop looks like this:
</p>
<pre>
while (GetMessage(&amp;msg, NULL, 0, 0)) {
 TranslateMessage(&amp;msg);
 DispatchMessage(&amp;msg);
}
</pre>
<p>
If a thread message is returned by
<a href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/messagesandmessagequeues/messagesandmessagequeuesreference/messagesandmessagequeuesfunctions/getmessage.asp">
the <code>GetMessage</code> function</a>,
it will just fall through the <code>TranslateMessage</code>
and <code>DispatchMessage</code> without any action being taken.
Lost forever.
</p>
<p>
Thread messages are generally to be avoided on threads that
create windows, for this very reason.
Of course, if you’re going to create a window, why not use
<code>PostMessage</code> instead, passing that window as the target
of the posted message?  Since there is now a window handle,
the <code>DispatchMessage</code> function knows to give the message
to your window procedure.  Result: Message not lost.</p>


</body>