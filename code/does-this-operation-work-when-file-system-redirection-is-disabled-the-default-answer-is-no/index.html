<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Does this operation work when file system redirection is disabled? The default answer is NO</h1>  <!-- .entry-meta -->

<p>A customer reported that when their program called <code>SH­Get­File­Info</code> to get the icon for a folder, the call failed. “It works on some machines but not others. We don’t know what the difference is between the working and non-working machines.” They included the offending function from their program, but everything in the function looked good. The problem was something outside the function itself.</p>
<p> Eventually, the customer confessed that they had called the <code>Wow64­Disable­Wow64­Fs­Redi­rection</code> function to disable file system redirection, and the call to <code>SH­Get­File­Info</code> took place while redirection was disabled. “We found that if we re-enable file system redirection before calling <code>SH­Get­File­Info</code>, then everything works properly.” </p>
<p> That’s right, because, <a href="http://blogs.msdn.com/b/oldnewthing/archive/2011/09/28/10217445.aspx"> like impersonation</a>, nothing works when file system redirection is disabled unless it is specifically documented as supporting disabled redirection. This is even called out in the documentation for <code>Wow64­Disable­Wow64­Fs­Redi­rection</code>: </p>
<blockquote class="q"><p> <b>Note</b>  The <b>Wow64­Disable­Wow64­Fs­Redi­rection</b> function affects all file operations performed by the current thread, <u>which can have unintended consequences if file system redirection is disabled for any length of time</u>. For example, DLL loading depends on file system redirection, so disabling file system redirection will cause DLL loading to fail. Also, many feature implementations use delayed loading and will fail while redirection is disabled. The failure state of the initial delay-load operation is persisted, so any subsequent use of the delay-load function will fail even after file system redirection is re-enabled. To avoid these problems, <u>disable file system redirection immediately before calls to specific file I/O functions (such as <b>Create­File</b>) that must not be redirected, and re-enable file system redirection immediately afterward</u> using <b>Wow64­Revert­Wow64­Fs­Redi­rection</b>. </p></blockquote>
<p> Whenever you use one of these “global solutions to a local problem” types of solutions that change some fundamental behavior of the system, you have to make sure that everybody is on board with your decision. </p>
<p> The local solution would be to use the <a href="http://blogs.msdn.com/b/oldnewthing/archive/2010/12/31/10110525.aspx"> <code>C:\Windows\Sys­Native</code></a> virtual directory for files you want to look up in the native system directory rather than the emulated system directory. </p>


</body>