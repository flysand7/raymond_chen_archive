<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Link-time code generation invalidates a lot of classical assumptions about linking</h1>  <!-- .entry-meta -->

<p>The <a href="/other/index-to-the-series-on-dll-imports-and-exports"> discussion of DLL imports and exports</a> from a few years back relied heavily on what I called <a href="https://devblogs.microsoft.com/oldnewthing/20130107-00/?p=5633"> the classical model of linking</a>. Even though modern linkers can be quite non-classical, they do what they can to preserve certain aspects of classical behavior because many projects still rely on them.</p>
<p>Recall that the classical division of labor between the compiler and the linker is that the compiler takes source code and generates machine code with a few blank spaces that says, “Hey, linker, I’m not sure what number goes here, but I want it to be the address of <i>X</i>. Please patch the correct number in when you figure it out where <i>X</i> is.” The linker’s job is to go find <i>X</i>, assign it an address, and patch the address of <i>X</i> into all the places that the compiler asked for.</p>
<p>In the Visual Studio system, one of the ways of activating a large set of non-classical behaviors is to enable <i>Whole program optimization</i>, also known as <i>Link-time code generation</i>. When this is enabled, the division of labor between the compiler and linker shifts. The compiler still takes source code, but instead of generating machine code, it merely generates a parse tree (perhaps partially-digested). The linker then takes all these parse trees, combines them together (according to classical rules), and generates machine code.</p>
<p>Since the code generation is done with the full parse tree of the entire program, the code generator can perform very advanced operations, like <a href="https://devblogs.microsoft.com/oldnewthing/20120831-00/?p=6713"> observing that a method is never overridden and can therefore be inlined</a>. In particular, starting with Visual Studio 2012, the link-time code generator can even see that <a href="https://devblogs.microsoft.com/oldnewthing/20060726-00/?p=30363"> you got <code>dllimport</code> wrong</a>, and it goes back in time and redeclares the function correctly before proceeding with code generation.</p>
<p>Non-classical linking is even more advanced than non-classical physics. Whereas special relativity lets you stretch and slow down time, non-classical linking even gives you a limited form of time travel.</p>


</body>