<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">The MIPS R4000, part 10: Trampolines and stubs</h1>  <!-- .entry-meta -->

<p>We saw earlier that the relative branch instructions have a reach of ±128<a href="https://blogs.msdn.microsoft.com/oldnewthing/20090611-00/?p=17933">KB</a>, but what if the function you want to call is further away than that? </p>
<p>The linker detects that the branch target is too far away and creates a trampoline stub, the same way <a href="https://blogs.msdn.microsoft.com/oldnewthing/20170807-00/?p=96766">the Alpha AXP compiler did</a>. The branch instruction is then rewritten to be a branch to the trampoline, and the trampoline performs another jump to the final destination. </p>
<pre>
    BAL     dest_trampoline ; was "BAL dest"
...
dest_trampoline:
    J       dest
    NOP                     ; branch delay slot
</pre>
<p>The limited reach of the relative branch instructions means that a single function cannot be larger than 256KB. </p>
<p>On the other hand, the existence of the <code>JAL</code> instruction means that the compiler doesn’t really need to use <code>BAL</code> at all. Trampolines come into play only with conditional calls, and those are relatively rare. </p>
<p>If a function is <a href="https://blogs.msdn.microsoft.com/oldnewthing/20060721-06/?p=30433">naïvely-imported</a>, then the compiler will generate a normal branch-and-link instruction, and the import library will provide a stub that in turn jumps indirectly through the import table. Doing this requires a scratch register, and that’s where the <var>at</var> register once again enters the picture: </p>
<pre>
    BAL     imported_function_stub
...

imported_function_stub:
    LUI     at, XXXX
    LW      at, YYYY(at)    ; load from import address table
    JR      at              ; and jump there
    NOP                     ; branch delay slot
</pre>
<p>Where <code>XXXX</code> and <code>YYYY</code> are computed in the usual way, namely, so that <code>(XXXX &lt;&lt; 16) + (int16_t)YYYY</code> is the address of the import address table entry. </p>
<p>If you are unlucky enough that you are calling an imported function naïvely, <i>and</i> the imported stub is beyond the reach of the <code>BAL</code> instruction, then you will have to bounce through two trampolines! The first was generated by the linker to help you reach the stub, and the second came from the import library to get you from the stub to the final destination. </p>
<p>This double-trampoline could also happen on the Alpha AXP, but it was less common because the Alpha AXP’s relative branch instructions have a reach of ±4MB, as opposed to the MIPS R4000’s relative branch instructions, which can reach only ±128KB. </p>


</body>