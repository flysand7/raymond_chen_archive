<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">The unhandled exception filter is the responsibility of the process; don’t change it without permission</h1>  <!-- .entry-meta -->

<p>A customer developed an Office add-in and wanted to intercept all unhandled exceptions so that they could collect crash dumps, capture stack traces, and so on. To do this, they used the <code>Set­Unhandled­Exception­Filter</code> function to register their custom unhandled exception handler to capture crash dumps and stack traces. </p>
<p>The customer reported that this technique was successful in earlier versions of Office, but stopped working starting in Office 2013. (They didn’t test Office 2010.) Their custom unhandled exception handler is no longer being called. </p>
<p>The customer wanted to know if there were any known circumstances where the <code>Set­Unhandled­Exception­Filter</code> function would stop working, and what workarounds were available, even if it means abandoning their current strategy and getting their crash dumps some other way. </p>
<p>The unhandled exception filter is a process-wide resource, and therefore the process is the one who makes the decision what unhandled exception filter they want. A DLL is a guest in the host process, and common courtesy says that guests don’t cancel the homeowner’s insurance policy and replace it with their own. </p>
<p>Besides, imagine what would happen if <i>two</i> plug-ins wanted to replace the unhandled exception filter. (Bonus: And then one of those plug-ins was unloaded.) </p>
<p>The Office team discovered that large numbers of add-ins were (either intentionally or inadvertently) corrupting the process-wide unhandled exception filter. This meant that crashes were no longer being routed through Office’s own unhandled exception filter. Not only were none of the crashes in Office being reported through Windows Error Reporting, users were losing data because Office’s custom unhandled exception filter was not getting a chance to attempt document recovery before the process finally went away. </p>
<p>To work around rogue DLLs replacing the unhandled exception filter, Office detours the <code>Set­Unhandled­Exception­Filter</code> function. </p>
<p><a href="https://groups.google.com/d/msg/microsoft.public.office.developer.com.add_ins/tv4nMiaHcJY/kS92bPNrHhsJ">This answer from Office developer support</a> confirms the above discussion and further suggests a workaround: Register your plug-in with <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb513641(v=vs.85).aspx">Windows Error Reporting</a>. Microsoft’s back-end error reporting service (known as Watson, not the same as <a href="https://blogs.msdn.microsoft.com/oldnewthing/20051114-00/?p=33353">Dr. Watson</a>). All the crashes received by the Watson service are analyzed, and if the analysis concludes that your plug-in was responsible for the problem, the crash dump will be made available to you. </p>


</body>