<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">So you decided to call SHFileOperation from a service, at least remember to disable copy hooks</h1>  <!-- .entry-meta -->

<p>I noted some time ago that <a href="http://blogs.msdn.com/b/oldnewthing/archive/2013/12/06/10474322.aspx">it is highly inadvisable to call <code>SHFile­Operation</code> from a service</a>, and then I thought about it some more and concluded, <a href="http://blogs.msdn.com/b/oldnewthing/archive/2014/11/21/10574758.aspx">it’s flat-out wrong, at least in the case where you call it while impersonating</a>. </p>
<p>Now, I’m sure that my opinion won’t dissuade many of you, but if you decide to do it anyway, at least disable shell copy hooks by passing the <code>FOFX_NO­COPY­HOOKS</code> flag to <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb775799(v=vs.85).aspx"><code>IFile­Operation::Set­Operation­Flags</code></a>. (We’ve <a href="http://blogs.msdn.com/b/oldnewthing/archive/2014/08/21/10551659.aspx">met this flag before</a>.) </p>
<p>By default, shell copy hooks are active during shell file operations, and this creates a number of problems when called from a service. </p>
<p>First of all, those copy hooks are unlikely to be designed to handle being run in a service. (When you write your own shell extension, <a href="http://blogs.msdn.com/b/oldnewthing/archive/2011/09/28/10217445.aspx">do you make sure it also works when run in a service</a>?) They’re probably going to try to log the file activity, possibly to a back-end service, or maybe check with a back-end service whether this file copy should be allowed, and if not, they’re probably going to display a dialog box saying “The file cannot be moved/copied/deleted <strike>because I’m a mean person who hates you</strike> due to restrictions imposed by your administrator.” (Or worse, they may secretly copy the file to an undisclosed location before allowing the operation through.) </p>
<p>Second of all, you probably don’t want those copy hooks intefering with your file operation, whatever it is. Your service is trying to clean up files, or it’s moving files around for its own internal purposes, and if a copy hook showed up and blocked the operation, your service is now in a weird inconsistent state. </p>
<p>Note that I still consider <code>SHFile­Operation</code> inadvisable from a service. I’m just trying to stop you from digging your hole any deeper than it already is. </p>


</body>