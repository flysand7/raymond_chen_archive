<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">The hunt for a faster syscall trap</h1>  <!-- .entry-meta -->

<p>The performance of the syscall trap gets a lot of attention.</p>
<p> I was reminded of a meeting that took place between Intel and Microsoft over fifteen years ago.  (Sadly, I was not myself at this meeting, so the story is second-hand.) </p>
<p> Since Microsoft is one of Intel’s biggest customers, their representatives often visit Microsoft to show off what their latest processor can do, lobby the kernel development team to support a new processor feature, and solicit feedback on what sort of features would be most useful to add. </p>
<p> At this meeting, the Intel representatives asked, “So if you could ask for only one thing to be made faster, what would it be?” </p>
<p> Without hesitation, one of the lead kernel developers replied, “Speed up faulting on an invalid instruction.” </p>
<p> The Intel half of the room burst out laughing. “Oh, you Microsoft engineers are so funny!” And so the meeting ended with a cute little joke. </p>
<p> After returning to their labs, the Intel engineers ran profiles against the Windows kernel and lo and behold, they discovered that Windows spent a lot of its time dispatching invalid instruction exceptions.  How absurd!  Was the Microsoft engineer not kidding around after all? </p>
<p> No he wasn’t. </p>
<p> It so happens that on the 80386 chip of that era, the fastest way to get from V86-mode into kernel mode was to execute an invalid instruction!  Consequently, Windows/386 used an invalid instruction as its syscall trap. </p>
<p> What’s the moral of this story?  I’m not sure. Perhaps it’s that when you create something, you may find people using it in ways you had never considered. </p>


</body>