<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">If each thread’s TEB is referenced by the fs selector, does that mean that the 80386 is limited to 1024 threads?</h1>  <!-- .entry-meta -->

<p>Commenter Waleri Todorov recalled that the global descriptor table (GDT), which is one of the places that selectors are defined, is limited to 1024 selectors. <!-- A HREF="https://blogs.msdn.microsoft.com/oldnewthing/20190204-00/?p=100855" --> Does that mean that there is a hard limit of 1024 threads?</p>
<p>The question was in the context of how Windows NT for the 80386 managed the thread environment block (TEB), namely, by using the <code>fs</code> register to point to the per-thread data. The point is that there are at most 1024 possible distinct values for the <code>fs</code> register to have, so does this implicitly limit the number of threads to 1024?</p>
<p>No, it doesn’t, because nobody said that the distinct values had to be different simultaneously.</p>
<p>Let’s start with a single-processor system. That single processor is executing only one thread at a time, so there needs to be only one valid value for <code>fs</code> at a time. When the processor changes threads, the definition of that selector is updated to refer to the TEB for the incoming thread. Using selectors to access another thread’s TEB is not part of the ABI; all that is required is that you can use <code>fs</code> to access <i>your own</i> TEB.</p>
<p>You can see this in the debugger. Break into a multithreaded program and look at the value of the <code>fs</code> register. On my system it’s <code>0x0053</code>. Switch to another thread and look at the value of the <code>fs</code> register. It’s the same value: <code>0x0053</code>. Every thread has the same selector in <code>fs</code>. What happens is that each time the processor changes threads, the GDT entry for <code>0x0053</code> is updated to refer to the TEB of the thread that is being scheduled.¹</p>
<p>This trick works even on multiprocessor systems. Each processor has its own GDTR internal register, so instead of sharing a single GDT for all processors, you can give each processor its own GDT.</p>
<p>So I guess this puts the theoretical maximum number of processors supported by an x86-based system at around twenty-four million, because that would exhaust all of kernel mode address space just for GDTs.²</p>
<p>No, wait, that’s still not the limit, because each processor also gets its own page table. After all, that’s how two processors can be executing threads from different processes (and therefore in different address spaces). So the theoretical limit is basically <i>until you run out of memory</i>.</p>
<p>But I suspect you’ll run into other problems long before you add that twenty-four-millionth processor.</p>
<p>¹ Bit 2 is clear for GDT selectors and set for LDT selectors, so you can infer that <code>0x0053</code> is a GDT selector.</p>
<p>² I calculated this by dividing 2³¹ by <code>0x60</code>, which is my presumed minimum size for a GDT. A selector whose numeric value is <code>0x0053</code> implies that the GDT is at least <code>0x0058</code> bytes in size, because that’s how big you need to be to get to a selector value of <code>0x0053</code> in the first place.</p>


</body>