<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">How did Windows 3.1’s virtual machine manager get the information to show in the text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> switcher?</h1>  <!-- .entry-meta -->

<p>When I told <a href="/history/the-life-story-of-the-switchtothiswindow-function" title="The life story of the SwitchToThisWindow function"> the life story of the <code>Switch­To­This­Window</code> function</a>, some people were curious about how the virtual machine manager knew about the current windows and their z-order, so that it could show them in the fake text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> switcher.</p>
<p>The virtual machine manager has a friend, namely the Windows program that provided the graphical user interface for the virtual machine, named <code>WINOLDAP</code>. It got that name because it is the program which provides the Windows user interface for old (MS-DOS) applications. If the MS-DOS virtual machine is running windowed, then this program’s main window draws a graphical depiction of the contents of the virtual machine’s screen. If the MS-DOS virtual machine is running full-screen, then this program’s main window doesn’t need to draw anything, but it is still there, ready to help out the virtual machine manager.</p>
<p>If you press the <kbd>Alt</kbd>+<kbd>Tab</kbd> hotkey while in a full-screen MS-DOS virtual machine, the virtual machine manager receives the hotkey and tries to emulate the graphical <kbd>Alt</kbd>+<kbd>Tab</kbd> user interface.</p>
<p>The text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> code asks the virtual machine scheduler to switch execution context to the Windows virtual machine, and then call it back once this has occurred.</p>
<p>In 16-bit Windows, the <code>Post­Message</code> function is special in that it is one of the few Windows function that could be called from a hardware interrupt handler. The callback function (now running in the context of the Windows virtual machine) saves the current virtual machine context, and then creates a new execution context that calls the <code>Post­Message</code> function, which from the virtual machine client’s point of view looks like a hardware interrupt in the sense that the function is being called out of the blue, from an unknown context. After the call to <code>Post­Message</code> function returns, the callback function restores the original context and allows execution to continue normally.</p>
<p>The message is posted to the <code>WINOLDAP</code> window, and when it receives the message, it gathers information about the next window in the <kbd>Alt</kbd>+<kbd>Tab</kbd> list, as well as information about the user’s color preferences. It then issues a kernel call into the text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> code, passing this information along.</p>
<p>The text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> code uses the color information to render a text-mode version of the <kbd>Alt</kbd>+<kbd>Tab</kbd> user interface, showing the name of the window being proposed as the switch destination.</p>

<p>If the user completes the <kbd>Alt</kbd>+<kbd>Tab</kbd> sequence, and the destination is a full-screen MS-DOS virtual machine, then the text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> switcher performs a direct virtual machine switch to the target. Performing the switch directly avoids bouncing through the Windows desktop. It then returns control back to <code>WINOLDAP</code> with a return value that means “You’re all done, do nothing more.”</p>
<p>If the destination is not a full-screen MS-DOS virtual machine, then the text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> code returns control back to <code>WINOLDAP</code> with a return value that means “Switch to this window and return,” and in response, <code>WINOLDAP</code> calls the <code>Switch­To­This­Window</code> function to tell the window manager to switch to the window in the style of <kbd>Alt</kbd>+<kbd>Tab</kbd>.</p>
<p>If the user continues the <kbd>Alt</kbd>+<kbd>Tab</kbd> sequence, either by tabbing forward or holding the <kbd>Shift</kbd> key to tab backward, then the text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> code returns control back to <code>WINOLDAP</code> with a return value that means “Get information about the next/previous window in the <kbd>Alt</kbd>+<kbd>Tab</kbd> order and call me back.”</p>
<p>The communication between the text-mode <kbd>Alt</kbd>+<kbd>Tab</kbd> code and <code>WINOLDAP</code> basically takes the form of a captive thread, where the <code>WINOLDAP</code> function issues a kernel call which doesn’t return until the user decides what they want to do next with the <kbd>Alt</kbd>+<kbd>Tab</kbd> sequence.</p>
<p>It’s a rather complicated dance (all written in assembly language, which was the fashion at the time) to accomplish something that looks so simple and obvious to the end user.</p>


</body>