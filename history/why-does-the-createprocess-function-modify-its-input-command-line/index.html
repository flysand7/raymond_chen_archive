<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why does the CreateProcess function modify its input command line?</h1>  <!-- .entry-meta -->

<p>One of the nasty gotchas of the <code>CreateProcess</code> function is that the <code>lpCommandLine</code> parameter must be a mutable pointer. If you pass a pointer to memory that cannot be written to (for example, a pointer to a page that is marked <code>PAGE_READONLY</code>), then you might crash. Commenter Ritchie  <a href="http://blogs.msdn.com/oldnewthing/pages/407234.aspx#578287"> wonders why this parameter is so weird</a>.</p>
<p> Basically, somebody back in the 1980’s wanted to avoid allocating memory. (Another way of interpreting this is that somebody tried to be a bit too clever.) </p>
<p> The <code>CreateProcess</code> temporarily modifies the string you pass as the <code>lpCommandLine</code> in its attempt to figure out where the program name ends and the command line arguments begin. Now, it could have made a copy of the string and made its temporary modifications to the copy, but hey, if you modify the input string directly, then you save yourself an expensive memory allocation operation. Back in the old days, <a href="http://blogs.msdn.com/oldnewthing/archive/2004/08/23/218837.aspx"> people worried about avoiding memory allocations</a>, so this class of micro-optimization is the sort of thing people worried about as a matter of course. Of course, nowadays, it seems rather antiquated. </p>
<p> Now, there may also be good technical reasons (as opposed to merely performance considerations) for avoiding allocating memory on the heap. When a program crashes, the <a href="http://www.microsoft.com/technet/prodtechnol/windows2000serv/reskit/regentry/11498.mspx"> just in time debugger is launched</a> with the <code>CreateProcess</code> function, and you don’t want to allocate memory on the heap if the reason the  program crashed is that <i>the heap is corrupted</i>. Otherwise, you can get yourself into a recursive crash loop: While trying to launch the debugger, you crash, which means you try to launch the debugger to debug the new crash, which again crashes, and so on. The original authors of the <code>CreateProcess</code> function were careful to avoid allocating memory off the heap, so that in the case the function is being asked to launch the debugger, it won’t get waylaid by a corrupted heap. </p>
<p> Whether these concerns are still valid today I am not sure, but it was those concerns that influenced the original design and therefore the interface. </p>
<p> Why is it that only the Unicode version is affected? Well, because the ANSI version of the function just converts its strings to Unicode and the calls the Unicode version of the function. Consequently, the ANSI version of the function happens to implement the workaround as a side effect of its original goal: The string passed to the Unicode version of the function is a temporary string! </p>
<p> <b>Exercise</b>: Why is it okay for the ANSI version of the <code>CreateProcess</code> to allocate a temporary string from the heap when the Unicode function cannot? </p>


</body>