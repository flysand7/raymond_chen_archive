<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Throwing garbage on the sidewalk: The sad history of the rundll32 program</h1>  <!-- .entry-meta -->

<p>During the development of Windows Vista, the application comaptibility team traced a bunch of issues back to people <a href="/code/what-can-go-wrong-when-you-mismatch-the-calling-convention"> corrupting the stack by using the <code>rundll32</code> program to call functions that were not designed to be called by <code>rundll32</code></a>.</p>
<p>The problems were often subtle. For example, a batch file which used <code>rundll32</code> incorrectly ended up hanging because the <code>rundll32</code> process never returned. The misaligned stack resulted in registers being restored from the stack incorrectly, and then the cleanup code inside <code>rundll32</code> ends up getting confused and wedging itself. The programs got away with it on previous versions of Windows by sheer luck. The version of the compiler used by Windows Vista contains different optimizations, and it ended up arranging stack variables and using registers differently, and what in previous versions of Windows was some corruption that went largely unnoticed became corruption that resulted in the program getting stuck in an infinite loop. Lucky no longer.</p>
<p>I was asked to come up with a solution for this problem, to fix the <code>rundll32</code> program so it was more resilient to people who used it incorrectly. To <i>fix other people’s bugs for them</i>.</p>
<p>The solution: Before calling the function, push a hundred bytes of garbage onto the stack (in case the called function pops too many bytes off the stack) and save the stack pointer in a global variable. After the function returns, restore the stack pointer, in case the called function pops too many or too few bytes off the stack. I think I may even have saved the processor registers in global variables, I forget.</p>
<p><b>Do not consider this free license to continue abusing the <code>rundll32</code> program.</b> When the pet store opens on Sundays, that doesn’t mean that it’s okay to <a href="https://devblogs.microsoft.com/oldnewthing/20100311-00/?p=14643"> keep throwing garbage on the sidewalk</a>.</p>


</body>