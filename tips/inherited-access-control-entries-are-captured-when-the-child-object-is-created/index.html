<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Inherited access control entries are captured when the child object is created</h1>  <!-- .entry-meta -->

<p>In the discussion of <a href="http://blogs.msdn.com/b/oldnewthing/archive/2015/10/07/10646148.aspx">how to change permissions as fast as Explorer does it</a>, it appears that it was not clear to people how inherited access control entries work, so there were a lot of suggestions based on faulty mental models. So let me explain. </p>
<p><a href="http://blogs.msdn.com/b/oldnewthing/archive/2006/08/24/717181.aspx">Inherited permissions on an object are established when the object is created</a>. Once the object has been created, you can change the permissions of the parent and it won’t have any effect unless you explicitly ask for the inheritable properties to be re-propagated to child objects. (You may recall that <a href="http://blogs.msdn.com/larryosterman/archive/2004/09/01/224051.aspx">the <code>CREATOR_OWNER</code> SID works in a similar way</a>.) </p>
<p>Let’s say this again. Each file has a security descriptor. To determine whether you can access a file, the only thing that is consulted is the security descriptor on the file being accessed. The security descriptors on the parent folders do not enter the picture, except possibly to determine whether traversal is allowed.¹ </p>
<p>Now, let’s talk about these alternate theories from the comments. </p>
<p>“<a href="http://blogs.msdn.com/b/oldnewthing/archive/2015/10/07/10646148.aspx#10646331">I suspect the <code>false</code> [second parameter to <code>Object­Security.Set­Access­Rule­Protection</code>] is the problem</a>.” </p>
<p>The security descriptor on a file can be marked as “protected”. This means “If somebody changes the security attributes on a parent folder and tries to propagate inheritable attributes to children, do not apply the inheritable attributes to me.” You can think of it as an “renounce inheritance” bit on a security descriptor. If you set the bit, then you’re saying, “I know my grandmother left me a collection of <a href="http://www.bing.com/images/search?q=animal+shaped+porcelain+creamers">antique creamers shaped like animals</a>, but I don’t want them.” </p>
<p>The <a href="https://msdn.microsoft.com/en-us/library/system.security.accesscontrol.objectsecurity.setaccessruleprotection%28v=vs.110%29.aspx"><code>Object­Security.Set­Access­Rule­Protection</code></a> method lets you set or clear the “renounce inheritance” bit, and if you choose to renounce the inheritance, you can set the second parameter to <code>false</code> to say that you want to renounce the access control entries that you already inherited. (Say, because they remind you of grandma’s unpleasant smell.) </p>
<p>While that last parameter is interesting, it has nothing to do with the problem at hand, since that bit controls the security attributes of a single file and does not perform any propagation. </p>
<p>“Does it take Explorer two minutes to change parent directory permissions when the ACL specifies that the changes are supposed to be inherited from the parent directory? <a href="http://blogs.msdn.com/b/oldnewthing/archive/2015/10/07/10646148.aspx#10646341">That would surprise me</a>. (Does inheritance work by altering every descendant rather than the permission check testing ancestors?)” </p>
<p>When you change the security attributes of a parent folder, you are typically asked whether you want to propagate inheritable attributes to children. If you say Yes, then the security attributes of the children are <i>overwritten</i> with values that are consistent with the security attributes of the parent. It is this step (rewriting security descriptors of all children) that takes a long time. </p>
<p>(The Advanced Security Settings dialog assumes you always say Yes, becaus it goes hunting up the parent tree looking for the source of your inheritable ACEs, and <a href="http://blogs.msdn.com/b/oldnewthing/archive/2015/05/05/10612220.aspx">it it doesn’t find one, it just shrugs</a>.) </p>
<p>Walking up the directory tree is a tricky proposition in practice for a variety of reasons. First of all, the existence of hard links means that a file can have multiple parent directories. Do you have to walk up all of them? Or only the one that was used to open the file? (In which case, it means that the effective security attributes of a file can vary depending on which path you use to open it.) And what if you open the file <a href="http://blogs.msdn.com/b/oldnewthing/archive/2011/02/28/10134679.aspx">by using its GUID</a> instead of a file name or path? What is the “parent directory”? </p>
<p>Windows takes the position that the security descriptor is an attribute of the object itself, not its containers. The container can influence the default security descriptor at the time a child object is created, but once that’s done, the child object can exercise its own free will and make its own choices. </p>
<p><b>Bonus chatter</b>: In practice, you may have a lot of files, but you almost never have a lot of unique security descriptors. For example, all the files in a directory typically have the same security descriptor, and a directory typically has the same security descriptor as its parent. Therefore, NTFS keeps all the security descriptors in a single table, and all the files with the same security descriptor share an entry in the table. </p>
<p>¹ Security checks on traversal are normally disabled, so by default, you can access anything whose security descriptor grants you access, as long as you know its path. You can take advantage of this: Create a directory, let’s call it <code>Parent</code>, that denies <i>List Folder Contents</i> to everyone. Inside this directory, create subdirectories that grant access only to certain people, and give the names of those subdirectories to those people. For example, you might grant Bob read access to the <code>Manhattan</code> subdirectory. Bob can <code>cd</code> into <code>Parent\Manhattan</code> to see what’s in it, but if Bob tries to <code>cd</code> into <code>Parent</code> and do a <code>dir</code>, he sees nothing. </p>


</body>