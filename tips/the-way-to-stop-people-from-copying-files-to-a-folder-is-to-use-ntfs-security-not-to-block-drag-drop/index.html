<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">The way to stop people from copying files to a folder is to use NTFS security, not to block drag/drop</h1>  <!-- .entry-meta -->

<p>A customer wanted to prevent users from copying files to certain locations, and they did it by hooking functions like <code>SHFileOperation</code> and failing the operation if the parameters were not to its liking. The customer found that the hooks stopped working in Windows Vista because Explorer in Windows Vista uses the new <code>IFileOperation</code> COM interface instead of using the old <code>SHFileOperation</code> function. The customer wanted assistance in getting their hook working again so they could prevent users from copying files to directories they wanted to block.
 Well, first of all, arbitrary function hooking is not supported by any version of Windows, so the customer was already in unsupported territory right off the bat. (There are some components which have an infrastructure for hooks, such as <a href="http://www.microsoft.com/whdc/driver/filterdrv/default.mspx"> file system filter drivers</a> or <a href="http://www.microsoft.com/msj/0599/LayeredService/LayeredService.aspx"> Winsock Layered Service Providers</a>.)
 Second, attempting to hook <code>SHFileOperation</code> to prevent the user from copying files into specific directories is looking at the problem at the wrong level, similar to the people who <a href="http://blogs.msdn.com/oldnewthing/archive/2009/04/10/9541813.aspx"> want to block drag/drop when what they really want to block is accidental drag/drop</a>. If you block copying files via drag/drop in Explorer, that won’t stop the user from copying files by other means, or by doing the “poor man’s copy” by opening the document from the source location and doing a <i>Save As</i> to create a duplicate in the destination.
 If you want to prevent the user from copying files to a directory, use the NTFS security model. Withhold <i>Create files</i> permission in the folder, and users will be blocked from copying files into the directory in Explorer, Notepad, or any other program.</p>
<p> <b>Related</b>: <a href="http://blogs.msdn.com/oldnewthing/archive/2008/01/31/7337160.aspx"> Shell policy is not the same as security</a>. </p>


</body>