<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why does the Disk Cleanup tool’s Windows Update Cleanup take so long and consume so much CPU?</h1>  <!-- .entry-meta -->

<p>If you ask the Disk Cleanup tool to clean up Windows Update files, you may find that it takes a long time and consumes a lot of CPU. What the heck is it doing? How hard can deleting files be?</p>
<p>The Windows Update Cleanup option is doing more than just deleting files. It’s basically doing two things.</p>
<p>First, it does the equivalent of <a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/clean-up-the-winsxs-folder"> <code>dism /Online /Cleanup-Image /StartComponentCleanup</code></a>. This is a command that goes by the nickname <i>deep clean</i>, and it scavenges the component catalog looking for components that are no longer being referenced. Normally, the system automatically does component scavenging on a schedule maintenance task. The automatic scavenging has a policy of waiting 30 days before removing an unreferenced component, and it also has a self-imposed time limit of one hour. But the special command line above bypasses both the 30-day grace period and the 1-hour timeout. Unreferenced components are removed immediately, and the task will run to completion, even if it takes more than an hour.</p>
<p>(I don’t know if the one hour timeout is actually meaningful in practice. I suspect it’s there just as a backstop in case the scavenging process goes haywire.)</p>
<p>The other thing that the <i>Windows Update Cleanup</i> task does is check with the <code>Wof­Should­Compress­Binaries</code> function to see whether the system would benefit from compression of system files. If so, then it takes the operating system files that aren’t already compressed and compresses them, storing the result in the WofCompressedData alternate data stream, as I described <a href="https://devblogs.microsoft.com/oldnewthing/20190618-00/?p=102597" title="What is WofCompressedData? Does WOF mean that Windows is a dog?"> some time ago</a>.</p>
<p>The compression algorithm used by the Windows Overlay Filter is higher quality than a real-time compression algorithm, and it’s designed so that decompression is fast, but compression is expensive. And that’s the cost: You need to spend a lot of CPU time to do the compression, which is why the <i>Windows Update Cleanup</i> is using so much CPU time.</p>
<p>And it’s doing the expensive data compression because it’s trying very hard to free up disk space. Because that’s presumably why you are running the Disk Cleanup tool.</p>


</body>