<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">The TEMP directory is like a public hot tub whose water hasn’t been changed in over a year</h1>  <!-- .entry-meta -->

<p>A customer reported that they couldn’t install product X. When they ran the installer, the got the error message</p>

<p>The product X setup team weren’t sure what to make of this, and they asked if anybody had any ideas.</p>
<p>The error code <code>0xc00000ba</code> is <a href="http://msdn.microsoft.com/en-us/library/cc704588(PROT.10).aspx"> <code>STATUS_<wbr/>FILE_<wbr/>IS_<wbr/>A_<wbr/>DIRECTORY</code></a>, which means that something was supposed to be a file, but instead it was a directory. <a href="https://devblogs.microsoft.com/oldnewthing/20120208-00/?p=8353"> The path-searching algorithm is not a backtracking algorithm</a>, so once it finds something wrong, it just stops rather than backing up and trying the next directory.</p>
<p>This was enough of a clue to direct further investigation, which revealed that the customer had a <i>directory</i> named <code>C:\<wbr/>Users\<wbr/>Bob\<wbr/>AppData\<wbr/>Local\<wbr/>Temp\<wbr/>version.dll\</code>. The customer responded, “There are plenty of directories with names of DLLs in my TEMP directory, but getting rid of this one fixes the issue. Thanks!”</p>
<p>(Puzzle: Why are there so many directories with the names of DLLs? <a href="http://support.microsoft.com/kb/311503">Psychic answer</a>.)</p>
<p>I slipped something past you a little while back. Did you notice?</p>
<p>Okay, I gave it away in the subject line. The setup program is running from the TEMP directory. That should already set off alarm bells.</p>
<p>The TEMP directory is a dumping ground of random junk. A downloader may have put a DLL there and forgotten to delete it. (Or worse, <a href="http://web.archive.org/web/20110205091635/http://blogs.msdn.com/b/oldnewthing/archive/2011/01/25/10119675.aspx#10120540"> expected it to stay there forever</a>.) And that DLL might be from an incompatible version of some DLL your setup program uses. (I have seen applications ship their own custom versions of system DLLs! Yeah, because the x86 version of <code>shlwapi.dll</code> from Windows 2000 is drop-in compatible with the version of <code>shlwapi.dll</code> that comes with Windows 7.) Who knows what other yucky things have been lying around in that directory. Since the application directory is the first directory searched when the system looks for a DLL, a rogue DLL in the TEMP directory is a trap waiting to be sprung. (A similar issue applies to a shared Downloads directory.)</p>
<p>It’s like the horror movie trope where the frightened pretty girl runs into a room, slams the door shut, then breathes a sigh of relief, believing herself to be safe. But she didn’t check that the room was empty! (In other words, she created her airtight hatchway around an insecure room.)</p>
<p>The Program X setup team decided to change their installer so that it created a <i>subdirectory</i> of TEMP and extracted the main setup program there. That way, it got a fresh hot tub with clean water.</p>
<p>Remember, <a href="https://devblogs.microsoft.com/oldnewthing/20110620-00/?p=10393"> the directory is the application bundle</a>. If you drop your application into a random directory, you’ve just added everything in that directory to your bundle. And if you don’t secure your application directory, you’re allowing anybody to add components to your bundle. That’s one of the reasons why the Logo program encourages (requires?) applications to install into the Program Files directory: The ACLs on the Program Files directory allow write access only to administrators and installers. This makes the application bundle secure by default. If you want to make your application bundle insecure, you have to go out of your way.</p>


</body>