<body style=max-width:80ch;margin:auto>
<h1 class="entry-title" style="margin-bottom:15px;">Why do Windows functions all begin with a pointless MOV EDI, EDI instruction?</h1>  <!-- .entry-meta -->

<p>If you look at the disassembly of functions inside Windows DLLs, you’ll find that they begin with the seemingly pointless instruction <code>MOV EDI, EDI</code>. This instruction copies a register to itself and updates no flags; it is completely meaningless. So why is it there?</p>
<p>It’s <a href="https://docs.microsoft.com/en-us/archive/blogs/ishai/why-does-the-compiler-generate-a-mov-edi-edi-instruction-at-the-beginning-of-functions"> a hot-patch point</a>.</p>
<p>The <code>MOV EDI, EDI</code> instruction is a two-byte <code>NOP</code>, which is just enough space to patch in a jump instruction so that the function can be updated on the fly. The intention is that the <code>MOV EDI, EDI</code> instruction will be replaced with a two-byte <code>JMP $-5</code> instruction to redirect control to five bytes of patch space that comes immediately before the start of the function. Five bytes is enough for a full jump instruction, which can send control to the replacement function installed somewhere else in the address space.</p>
<p>Although the five bytes of patch space before the start of the function consists of five one-byte <code>NOP</code> instructions, the function entry point uses a single two-byte <code>NOP</code>.</p>
<p><i>Why not use Detours to hot-patch the function, then you don’t need any patch space at all.</i></p>
<p>The problem with Detouring a function during live execution is that you can never be sure that at the moment you are patching in the Detour, another thread isn’t in the middle of executing an instruction that overlaps the first five bytes of the function. (And you have to alter the code generation so that no instruction starting at offsets 1 through 4 of the function is ever the target of a jump.) You could work around this by <!-- A HREF="http://blogs.msdn.com/b/ishai/archive/2004/06/24/165143.aspx#166003" --> suspending all the threads while you’re patching, but that still won’t stop somebody from doing a <code>CreateRemoteThread</code> after you thought you had successfully suspended all the threads.</p>
<p><i>Why not just use two <code>NOP</code> instructions at the entry point?</i></p>
<p>Well, because a <code>NOP</code> instruction consumes one clock cycle and one pipe, so two of them would consume two clock cycles and two pipes. (The instructions will likely be paired, one in each pipe, so the combined execution will take one clock cycle.) On the other hand, the <code>MOV EDI, EDI</code> instruction consumes one clock cycle and one pipe. (In practice, the instruction will occupy one pipe, leaving the other available to execute another instruction in parallel. You might say that the instruction executes in half a cycle.) However you calculate it, the <code>MOV EDI, EDI</code> instruction executes in half the time of two <code>NOP</code> instructions.</p>
<p>On the other hand, the five <code>NOP</code>s inserted before the start of the function are never executed, so it doesn’t matter what you use to pad them. It could’ve been five garbage bytes for all anybody cares.</p>
<p>But much more important than cycle-counting is that the use of a two-byte <code>NOP</code> avoids the Detours problem: If the code had used two single-byte <code>NOP</code> instructions, then there is the risk that you will install your patch just as a thread has finished executing the first single-byte <code>NOP</code> and is about to begin executing the second single-byte <code>NOP</code>, resulting in the thread treating the second half of your <code>JMP $-5</code> as the start of a new instruction.</p>
<p>There’s a lot of patching machinery going on that most people don’t even realize. Maybe at some point, I’ll get around to writing about how the operating system manages patches for software that isn’t installed yet, so that when you do install the software, the patch is already there, thereby closing the vulnerability window between installing the software and downloading the patches.</p>


</body>